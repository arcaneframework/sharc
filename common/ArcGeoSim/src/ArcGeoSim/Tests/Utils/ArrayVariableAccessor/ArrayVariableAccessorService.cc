#include "ArrayVariableAccessorService.h"
/* Author : dechaiss at Wed Aug 26 11:29:27 2009
 * Generated by createNew
 */

#ifdef WIN32
#include <ciso646>
#endif

#include <arcane/IVariableMng.h>
#include <arcane/IMesh.h>
#include <arcane/IItemFamily.h>
#include <arcane/ArcaneVersion.h>

#include "ArcGeoSim/Mesh/Utils/VariableUtils.h"

using namespace Arcane;

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

void
ArrayVariableAccessorService::
init(const ItemGroup& group)
{
  if (m_initialized)
    return;

  //! Variable manager
  IVariableMng * variable_mng = subDomain()->variableMng();

  //! Variable name
  String variable_name = options()->name();

  //! Find variable
  m_ivariable = variable_mng->findMeshVariable(mesh(), variable_name);

  //! Check compatibility
  if (m_ivariable == NULL)
    {
      fatal() << "Variable '" << variable_name << "' not defined";
    }

  // Data type => Real
  if (m_ivariable->dataType() != DT_Real)
    {
      fatal() << "Variable '" << variable_name
          << "' data type not REAL (actually only used)";
    }

  //! Check group compatibility
  if (group.itemKind() != m_ivariable->itemKind())
    fatal() << "Incompatible kind between " << m_ivariable->name()
    << " variable and " << group.name() << " group";

  m_initialized = true;

}

/*---------------------------------------------------------------------------*/

IVariable*
ArrayVariableAccessorService::
variable(const ItemGroup& group)
{
  if (!m_initialized)
    {
      fatal() << "Service not initialized";
    }

  // Check if variable is used, if not reconstruct it
  if (!m_ivariable->isUsed())
    {
      m_ivariable->setUsed(true);
      if (m_ivariable->computeFunction()) m_ivariable->computeFunction()->execute();
    }// Warning variable stay in used state

  //! Extract element from array

  //! Store extracted element number
  Integer component_index = options()->arrayElementNb();

  //! Extract component from mesh array variable
  Arcane::SharedArray<IVariable*> array_variable_components = ArcGeoSim::VariableUtils::extractArrayComponents(m_ivariable);

  //! Check conformity
  if (array_variable_components.size() <= component_index || component_index < 0)
    {
      fatal() << Arcane::String::format("Variable {0} has {1} element. Cannot access to element number {2}. Element Indexes must belong to [0 ,size-1]",
                                        m_ivariable->name(),array_variable_components.size(),component_index);
    }

  //! Create the associated IVariable
  IVariable * result_variable = array_variable_components[component_index];

  //! Check compatibility
  if (result_variable == NULL)
    fatal() << "Cannot check undefined variable " << m_ivariable->name() ;
  if (result_variable->dimension() != 1 or result_variable->dataType() != DT_Real)
    fatal() << "ArrayVariableAccessor must create an IVariable referencing a scalar real mesh variable";

  return result_variable;
}

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

ARCANE_REGISTER_SERVICE_ARRAYVARIABLEACCESSOR(ArrayVariableAccessor,ArrayVariableAccessorService);
