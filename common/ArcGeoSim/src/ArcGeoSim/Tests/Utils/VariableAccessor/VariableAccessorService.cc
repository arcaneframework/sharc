// -*- tab-width: 2; indent-tabs-mode: nil; coding: utf-8-with-signature -*-
//-----------------------------------------------------------------------------
// Copyright 2000-2022 CEA (www.cea.fr) IFPEN (www.ifpenergiesnouvelles.com)
// See the top-level COPYRIGHT file for details.
// SPDX-License-Identifier: Apache-2.0
//-----------------------------------------------------------------------------
#include "VariableAccessorService.h"
/* Author : desrozis at Wed Dec 17 15:34:42 2008
 * Generated by createNew
 */

#include <arcane/IVariableMng.h>

using namespace Arcane;

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

void
VariableAccessorService::init(const ItemGroup& group)
{
  if (m_initialized)
    return;
  
  // Manager de variables
  IVariableMng * variable_mng = subDomain()->variableMng();

  // Nom de la variable
  String variable_name = options()->name();

  // Recherche de la variable
  m_ivariable = variable_mng->findMeshVariable(mesh(), variable_name);

  if (m_ivariable == NULL)
    {
      fatal() << "Variable '" << variable_name << "' not defined";
    }

  // Verification du type de donnees => uniquement Real et Int32
  if (m_ivariable->dataType() != DT_Real && m_ivariable->dataType() != DT_Int32)
    {
      fatal() << "Variable '" << variable_name
          << "' data type not REAL or not Int32 (actually only used)";
    }

  // Verification de la dimension => uniquement 1
  if (m_ivariable->dimension() != 1)
    {
      fatal() << "Variable '" << variable_name
          << "' dimension != 1 (actually only used)";
    }

  m_initialized = true;
  //! Check group compatibility
  if (group.itemKind() != m_ivariable->itemKind())
    {
      fatal() << "Incompatible kind between " << m_ivariable->name()
          << " variable and " << group.name() << " group";
    }
}

/*---------------------------------------------------------------------------*/

IVariable *
VariableAccessorService::variable(const ItemGroup& group)
{
  if (!m_initialized)
    {
      fatal() << "Service not initialized";
    }

  // Check if variable is used, if not reconstruct it
  if (!m_ivariable->isUsed())
    {
      m_ivariable->setUsed(true);
      if (m_ivariable->computeFunction()) m_ivariable->computeFunction()->execute();
    }// Warning variable stay in used state

  return m_ivariable;
}

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

ARCANE_REGISTER_SERVICE_VARIABLEACCESSOR(VariableAccessor,VariableAccessorService);
