#include "AnalyticAccessorService.h"
/* Author : desrozis at Wed Dec 17 18:21:21 2008
 * Generated by createNew
 */

#include "ArcGeoSim/Appli/IAppServiceMng.h"
#include <arcane/IMesh.h>

using namespace Arcane;

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

void
AnalyticAccessorService::init(const ItemGroup& group)
{
  info() << A_FUNCINFO;

  // find IAppServiceMng
  IServiceMng * service_mng = subDomain()->serviceMng();
  IAppServiceMng * app_service_mng = IAppServiceMng::instance(service_mng);

  // Look for a suitable geometric service
  m_geometry_mng = app_service_mng->find<IGeometryMng> (true);

  // add cell center property
  m_geometry_mng->addItemGroupProperty(group, IGeometryProperty::PCenter,
                                       IGeometryProperty::PVariable);

}

/*---------------------------------------------------------------------------*/

void
AnalyticAccessorService::createVariable(const ItemGroup& group)
{
  // find analytic expression
  IFunctionR3vR1 * expression = options()->expression();

  // initialize expression
  expression->init();

  // Variable allocation
  m_mesh_variable.reset(new ItemVariableScalarRefT<Real> (VariableBuildInfo(group.mesh(), 
                                                                            "AnalyticAccessorVariable", 
                                                                            group.itemFamily()->name(),
                                                                            IVariable::PNoRestore),
                                                          group.itemKind()));

  // Conversion to IVariable
  m_ivariable = m_mesh_variable->variable();

  const Integer data_size = group.own().size();

  SharedArray<Real> x(data_size);
  SharedArray<Real> y(data_size);
  SharedArray<Real> z(data_size);
  SharedArray<Real> r(data_size);


  switch(m_geometry_mng->dimension())
  {
    case IGeometryMng::Dimension::e2Dxy :
      {
        // get cell center
        IGeometry2DMng* geometry2d_mng = dynamic_cast<IGeometry2DMng*>(m_geometry_mng) ;
        const IGeometry2DMng::Real2Variable& item_center = geometry2d_mng->getReal2VariableProperty(group, IGeometryProperty::PCenter);

        // recopy
        // to be removed when IFunctionR3vR1 interface implements eval(Real3,Real) method

        {
          Integer iData = 0;
          ENUMERATE_ITEM    (iitem, group.own())
            {
              const Item& item = *iitem;

              const Real2& center = item_center[item];

              x[iData] = center.x;
              y[iData] = center.y;
              z[iData] = 0.;
              iData++;
            }
        }
      }
      break ;
    case IGeometryMng::Dimension::e3Dxyz :
    default :
    {
      // get cell center
      const IGeometryMng::Real3Variable & item_center =
        m_geometry_mng->getReal3VariableProperty(group,
                                                 IGeometryProperty::PCenter);

      {
        Integer iData = 0;
        ENUMERATE_ITEM    (iitem, group.own())
          {
            const Item& item = *iitem;

            const Real3& center = item_center[item];

            x[iData] = center.x;
            y[iData] = center.y;
            z[iData] = center.z;
	    
            iData++;
          }
      }
    }
    break ;
  }
  

  // Evaluate analytic solution
  expression->eval(x, y, z, r);

  // and recopy... very very no good

  {
    ItemVariableScalarRefT<Real>& variable = *m_mesh_variable;

    Integer iData = 0;

    ENUMERATE_ITEM(iitem, group.own())
      {
        const Item& item = *iitem;

        variable[item] = r[iData];

        iData++;
      }
  }

  m_ivariable_is_created = true;
}

/*---------------------------------------------------------------------------*/

IVariable *
AnalyticAccessorService::variable(const ItemGroup& group)
{
  if (!m_ivariable_is_created)
    {
      createVariable(group);
    }

  return m_ivariable;
}

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

ARCANE_REGISTER_SERVICE_ANALYTICACCESSOR(AnalyticAccessor,AnalyticAccessorService);
