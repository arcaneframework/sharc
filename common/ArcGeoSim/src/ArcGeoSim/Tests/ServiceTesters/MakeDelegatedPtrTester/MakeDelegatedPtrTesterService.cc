// -*- C++ -*-
/* Author : desrozis at Wed Aug 26 11:22:48 2015
 * Generated by createNew
 */

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

#include "ArcGeoSim/Tests/ServiceTesters/IServiceTester.h"

#include "MakeDelegatedPtrTester_axl.h"

#include "ArcGeoSim/Utils/MakeDelegatedPtr.h"

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

class MakeDelegatedPtrTesterService
  : public ArcaneMakeDelegatedPtrTesterObject
{
private:
  
  struct Test
  {
    Test(bool& is_desallocated)
      : m_is_desallocated(is_desallocated) {}

    ~Test()
    {
      std::cout << "object is desallocated\n";
      m_is_desallocated = true;
    }

    bool& m_is_desallocated;
  };
  
public:
 
  MakeDelegatedPtrTesterService(const Arcane::ServiceBuildInfo& sbi)
    : ArcaneMakeDelegatedPtrTesterObject(sbi) {}

  ~MakeDelegatedPtrTesterService() {}
  
public:
  
  void init();

  Arcane::Integer test() { return 1; }
};

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

void
MakeDelegatedPtrTesterService::
init()
{
  info() << "MakeDelegatedSharedPtr tester";

  bool is_desallocated = false;

  {
    std::shared_ptr<Test> t = std::make_shared<Test>(is_desallocated);
  }

  if(is_desallocated != true)
    fatal() << "Test is not desallocated (std::shared_ptr)";

  is_desallocated = false;

  std::shared_ptr<Test> t = std::make_shared<Test>(is_desallocated);

  {
    std::shared_ptr<Test> u = ArcGeoSim::makeDelegatedSharedPtr<Test>(t.get());

    if(u.get() != t.get())
      fatal() << "pointer assignment error";
  }

  if(is_desallocated == true)
    fatal() << "Test is desallocated (ArcGeoSim::makeDelegatedSharedPtr)";

  {
    std::shared_ptr<Test> u;
    {
      std::shared_ptr<Test> v = ArcGeoSim::makeDelegatedSharedPtr<Test>(t.get());

      if(v.get() != t.get())
        fatal() << "pointer assignment error";
      u = v;
    }

    if(u.get() != t.get())
      fatal() << "pointer assignment error";
  }

  if(is_desallocated == true)
    fatal() << "Test is desallocated (ArcGeoSim::makeDelegatedSharedPtr)";
}

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

using namespace Arcane;
ARCANE_REGISTER_SERVICE_MAKEDELEGATEDPTRTESTER(MakeDelegatedPtrTester,MakeDelegatedPtrTesterService);
