// -*- C++ -*-
/* Author : desrozis at Thu Jun  9 14:09:09 2016
 * Generated by createNew
 */

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

#include "ArcGeoSim/Tests/ServiceTesters/IServiceTester.h"

#ifdef USE_ALIEN_V1
#include <ArcGeoSim/Numerics/AlienTools/BasicIndexManager.h>
#endif

#ifdef USE_ALIEN_V2
#include <alien/arcane_tools/IIndexManager.h>
#include <alien/arcane_tools/indexManager/BasicIndexManager.h>
#endif

#include "IndexManagerTester_axl.h"

#include <arcane/ArcaneVersion.h>

#if (ARCANE_VERSION < 20200)
  #include <arcane/dof/ConnectivityManager.h>
  typedef Arcane::ConnectivityManager ItemConnectivityMng;
  #include <arcane/dof/DoFManager.h>
#else
  #if (ARCANE_VERSION >= 22200)
    #include <arcane/mesh/ItemConnectivityMng.h>
    #include <arcane/mesh/DoFManager.h>
  #else
    #include <arcane/dof/ItemConnectivityMng.h>
    #include <arcane/dof/DoFManager.h>
  #endif
  using Arcane::ItemConnectivityMng;
#endif

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

class IndexManagerTesterService 
  : public ArcaneIndexManagerTesterObject
{
public:
  
  IndexManagerTesterService(const Arcane::ServiceBuildInfo & sbi) 
    : ArcaneIndexManagerTesterObject(sbi)
#if ARCANE_VERSION < 31307
      , m_connectivity_mng(sbi.subDomain()->traceMng())
      , m_dof_mng(sbi.mesh(), &m_connectivity_mng) {}
#else
      , m_dof_mng(sbi.mesh()) {}
#endif

  ~IndexManagerTesterService() {}
  
public:

  void init();

  int test();

private:

  int test_1();
  int test_2();

private:
#if ARCANE_VERSION < 31307
  ItemConnectivityMng m_connectivity_mng;
#endif

  Arcane::DoFManager m_dof_mng;
};

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

void 
IndexManagerTesterService::
init()
{
  info() << "init IndexManagerTester";

  auto size_A = 4;
  Arcane::Int64SharedArray dof_uids_A(size_A);
  for(auto i = 0; i < size_A; ++i)
    dof_uids_A[i] = i;
  Arcane::Int32SharedArray dof_lids_A(size_A);

  auto size_B = 2;
  Arcane::Int64SharedArray dof_uids_B(size_B);
  for(auto i = 0; i < size_B; ++i)
    dof_uids_B[i] = i + 10 * size_A;
  Arcane::Int32SharedArray dof_lids_B(size_B);

  info() << "create dof families";

  auto& dof_family_A = m_dof_mng.family("DofFamilyA");
  auto& dof_family_B = m_dof_mng.family("DofFamilyB");

  auto dofs_A = dof_family_A.addDoFs(dof_uids_A, dof_lids_A);
  auto dofs_B = dof_family_B.addDoFs(dof_uids_B, dof_lids_B);
#if (ARCANE_VERSION >= 20305)
  dof_family_A.endUpdate();
  dof_family_B.endUpdate();
#endif

  info() << " - dof family : " << dof_family_A.name() << ", size=" << dofs_A.size();
  info() << " - dof family : " << dof_family_B.name() << ", size=" << dofs_B.size();

  {
    auto* idof_family_A = mesh()->findItemFamily(Arcane::IK_DoF, "DofFamilyA");
    info() << "check dof families from mesh :";
    info() << " - idof_family_A " << idof_family_A->name();
    info() << " -- dof_family nbItem " << idof_family_A->nbItem();
    ENUMERATE_DOF(idof, idof_family_A->allItems()) {
      info() << "  * dof lid=" << idof->localId() << ", uid=" << idof->uniqueId();
    }
    info() << " -- dofs.size = " << dofs_A.size();
  }
  {
    auto* idof_family_B = mesh()->findItemFamily(Arcane::IK_DoF, "DofFamilyB");
    info() << "check dof families from mesh :";
    info() << " - idof_family_B " << idof_family_B->name();
    info() << " -- dof_family nbItem " << idof_family_B->nbItem();
    ENUMERATE_DOF(idof, idof_family_B->allItems()) {
      info() << "  * dof lid=" << idof->localId() << ", uid=" << idof->uniqueId();
    }
    info() << " -- dofs.size = " << dofs_A.size();
  }
#ifdef USE_ALIEN_V1
  Alien::BasicIndexManager index_manager(subDomain()->parallelMng());
#endif
#ifdef USE_ALIEN_V2
  Alien::ArcaneTools::BasicIndexManager index_manager(subDomain()->parallelMng());
#endif
}

/*---------------------------------------------------------------------------*/

int
IndexManagerTesterService::
test()
{
  test_1();
  test_2();

  return 1;
}

/*---------------------------------------------------------------------------*/

int
IndexManagerTesterService::
test_1()
{
  info() << "test IndexManagerTester with same family";

  auto* dof_family_A = mesh()->findItemFamily(Arcane::IK_DoF, "DofFamilyA");

  info() << "test DofFamilyA.allItem() twice";
#ifdef USE_ALIEN_V1
  Alien::BasicIndexManager index_manager(subDomain()->parallelMng());
#endif
#ifdef USE_ALIEN_V2
  Alien::ArcaneTools::BasicIndexManager index_manager(subDomain()->parallelMng());
#endif
  index_manager.setTraceMng(traceMng()) ;
  auto is_A = index_manager.buildScalarIndexSet("DofA", dof_family_A->allItems());
  Arcane::ItemGroup g = dof_family_A->createGroup("SubGroup");
  Arcane::Int32SharedArray lids(2);
  lids[0] = 0;
  lids[1] = 1;
  g.addItems(lids);
  auto is_B = index_manager.buildScalarIndexSet("DofB", g);
  index_manager.prepare();
  info() << "- indexes of DofFamilyA + DofFamilyB";
  auto id_A = index_manager.getIndexes(is_A);
  for(auto i = 0; i < id_A.size(); ++i) {
      info() << "id_A[" << i << "] = " << id_A[i];
  }
  auto id_B = index_manager.getIndexes(is_B);
  for(auto i = 0; i < id_B.size(); ++i) {
      info() << "id_B[" << i << "] = " << id_B[i];
  }

  return 1;
}

/*---------------------------------------------------------------------------*/

int
IndexManagerTesterService::
test_2()
{
  info() << "test IndexManagerTester with multiple family";

  auto* dof_family_A = mesh()->findItemFamily(Arcane::IK_DoF, "DofFamilyA");
  auto* dof_family_B = mesh()->findItemFamily(Arcane::IK_DoF, "DofFamilyB");

  {
    info() << "test DofFamilyA";
#ifdef USE_ALIEN_V1
    Alien::BasicIndexManager index_manager(subDomain()->parallelMng());
#endif
#ifdef USE_ALIEN_V2
    Alien::ArcaneTools::BasicIndexManager index_manager(subDomain()->parallelMng());
#endif
    index_manager.setTraceMng(traceMng());
    auto is_A = index_manager.buildScalarIndexSet("DofA", dof_family_A->allItems());
    index_manager.prepare();
    info() << "- indexes of DofFamilyA";
    auto id_A = index_manager.getIndexes(is_A);
    for(auto i = 0; i < id_A.size(); ++i) {
      info() << "id_A[" << i << "] = " << id_A[i];
    }
  }
  {
    info() << "test DofFamilyA";
#ifdef USE_ALIEN_V1
    Alien::BasicIndexManager index_manager(subDomain()->parallelMng());
#endif
#ifdef USE_ALIEN_V2
    Alien::ArcaneTools::BasicIndexManager index_manager(subDomain()->parallelMng());
#endif
    index_manager.setTraceMng(traceMng()) ;
    auto is_B = index_manager.buildScalarIndexSet("DofB", dof_family_B->allItems());
    index_manager.prepare();
    info() << "- indexes of DofFamilyB";
    auto id_B = index_manager.getIndexes(is_B);
    for(auto i = 0; i < id_B.size(); ++i) {
      info() << "id_B[" << i << "] = " << id_B[i];
    }
  }
  {
    info() << "test DofFamilyA + DofFamilyB";
#ifdef USE_ALIEN_V1
    Alien::BasicIndexManager index_manager(subDomain()->parallelMng());
#endif
#ifdef USE_ALIEN_V2
    Alien::ArcaneTools::BasicIndexManager index_manager(subDomain()->parallelMng());
#endif
    index_manager.setTraceMng(traceMng()) ;
    auto is_A = index_manager.buildScalarIndexSet("DofA", dof_family_A->allItems());
    auto is_B = index_manager.buildScalarIndexSet("DofB", dof_family_B->allItems());
    index_manager.prepare();
    info() << "- indexes of DofFamilyA + DofFamilyB";
    auto id_A = index_manager.getIndexes(is_A);
    for(auto i = 0; i < id_A.size(); ++i) {
      info() << "id_A[" << i << "] = " << id_A[i];
    }
    auto id_B = index_manager.getIndexes(is_B);
    for(auto i = 0; i < id_B.size(); ++i) {
      info() << "id_B[" << i << "] = " << id_B[i];
    }
  }

  return 1;
}

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

using namespace Arcane;
ARCANE_REGISTER_SERVICE_INDEXMANAGERTESTER(IndexManagerTester,IndexManagerTesterService);
