// -*- C++ -*-
/* Author : desrozis at Fri Oct 24 12:03:23 2014
 * Generated by createNew
 */

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

#include "ArcGeoSim/Tests/ServiceTesters/IServiceTester.h"

#include "ModuleMasterTester_axl.h"

#include "ArcGeoSim/Appli/Architecture/Delegate.h"
#include "ArcGeoSim/Appli/Architecture/IIterationInformation.h"
#include "ArcGeoSim/Appli/Architecture/IExtraEntryPoints.h"
#include "ArcGeoSim/Appli/Architecture/INextTimeComputer.h"

#include "ArcGeoSim/Appli/ITimeLoopSnapshotManager.h"
#include "ArcGeoSim/Appli/AppService.h"

#include <arcane/ISubDomain.h>
#include <arcane/ITimeLoopMng.h>

#include <set>

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

class ModuleMasterTesterService 
  : public ArcaneModuleMasterTesterObject
  , public ArcGeoSim::Delegate<ArcGeoSim::IIterationInformation>
  , public ArcGeoSim::Delegate<ArcGeoSim::IExtraEntryPoints>
  , public ArcGeoSim::Delegate<ArcGeoSim::INextTimeComputer>
{
public:
  
  ModuleMasterTesterService(const Arcane::ServiceBuildInfo & sbi) 
    : ArcaneModuleMasterTesterObject(sbi)
    , m_iteration(0)
    , m_goon(true) {}
  
  ~ModuleMasterTesterService() {}
  
public:
  
  void init();

  int test();
  
  bool goOn() { return m_goon; }

  void firstBuild();
  void firstStartInit();
  void firstContinueInit();
  void firstInit();
  void firstComputeLoop();
  void firstOnMeshChanged();
  void firstRestore();
  void firstExit();
  
  //! Points d'entrées AutoLoadEnd
  void lastBuild();
  void lastStartInit();
  void lastContinueInit();
  void lastInit();
  void lastComputeLoop();
  void lastOnMeshChanged();
  void lastRestore();
  void lastExit();

  //! Modifications liées au temps
  // 
  // global_time += global_deltat
  //
  // On souhaite en avoir la maîtrise pour éviter
  // les erreurs numériques pour les évènements
  void timeIncrementation();

  //! Affichage de l'information en temps
  void timeStepInformation(Arcane::Integer nb_loop);

private:

  void _fillVariables();
  void _checkVariables();
  
private:

  Arcane::Integer m_iteration;

  std::set<Arcane::Integer> m_restore_iteration;

  bool m_goon;
};

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

void
ModuleMasterTesterService::
init()
{
  info() << "############################### " << A_FUNCINFO;

  ArcGeoSim::AppService<ArcGeoSim::ITimeLoopSnapshotManager> snapshot_mng;
  
  snapshot_mng->setVerbosity(true);

  snapshot_mng->snap(m_cell_scalar);
  snapshot_mng->snap(m_face_array);
  snapshot_mng->snap(m_scalar_ref, m_scalar_snap);
  snapshot_mng->snap(m_array_ref, m_array_snap);

  for(Arcane::Integer i = 0; i < options()->restoreAtIteration().size(); ++i) 
    m_restore_iteration.insert(options()->restoreAtIteration()[i]);

  m_global_deltat = 1.;

  _fillVariables();
}

/*---------------------------------------------------------------------------*/

Arcane::Integer 
ModuleMasterTesterService::
test()
{
  info() << "############################### " << A_FUNCINFO;
  
  _checkVariables();
  _fillVariables();
  
  m_iteration += 1;
 
  info() << "iteration = " << m_iteration;
 
  std::set<Arcane::Integer>::const_iterator it = m_restore_iteration.find(m_iteration);
  
  if(it != m_restore_iteration.end()) {
    subDomain()->timeLoopMng()->goBackward();
    return 1;
  }

  info() << "iteration-max = " << options()->iterationMax();

  if(m_iteration > options()->iterationMax()) { 
    m_goon = false;
  }
  
  return 1;
}

/*---------------------------------------------------------------------------*/

void
ModuleMasterTesterService::
_fillVariables()
{
  m_cell_scalar.fill(m_global_time());
  m_face_array.resize(2);
  m_face_array.fill(m_global_time());
  m_scalar_ref.fill(m_global_time() + 1.);
  m_array_ref.resize(3);
  m_array_ref.fill(m_global_time() + 1.);
}

/*---------------------------------------------------------------------------*/

void
ModuleMasterTesterService::
_checkVariables()
{
  ArcGeoSim::AppService<ArcGeoSim::ITimeLoopSnapshotManager> snapshot_mng;
  
  Arcane::VariableCellReal cell_scalar_snap(snapshot_mng->snapshot(m_cell_scalar));
  
  ENUMERATE_CELL(icell,allCells()) {
    if(m_cell_scalar[icell] != cell_scalar_snap[icell]) 
      fatal() << "check variable error 1";
    if(m_scalar_ref[icell] != m_scalar_snap[icell]) 
      fatal() << "check variable error 2";
  }

  // Constructeur manquant dans Arcane
  // TODO!!
  
  // Arcane::VariableFaceArrayReal face_array_snap(snapshot_mng->snapshot(m_face_array));
  
  // ENUMERATE_FACE(iface,allFaces()) {
  //   for(Arcane::Integer i = 0; i < m_face_array.arraySize(); ++i)
  //     if(m_face_array[iface][i] != face_array_snap[iface][i]) 
  //       fatal() << "check variable error 3";
  //   for(Arcane::Integer i = 0; i < m_array_ref.arraySize(); ++i)
  //     if(m_array_ref[iface][i] != m_array_snap[iface][i]) 
  //       fatal() << "check variable error 4";
  // }
}

/*---------------------------------------------------------------------------*/

void 
ModuleMasterTesterService::
firstBuild() { info() << "############################### "<< A_FUNCINFO; }

void 
ModuleMasterTesterService::
firstStartInit() { info() << "############################### "<< A_FUNCINFO; }

void 
ModuleMasterTesterService::
firstContinueInit() { info() << "############################### " << A_FUNCINFO; }

void 
ModuleMasterTesterService::
firstInit() { info() << "############################### " << A_FUNCINFO; }

void 
ModuleMasterTesterService::
firstComputeLoop() { info() << "############################### " << A_FUNCINFO; }

void 
ModuleMasterTesterService::
firstOnMeshChanged() { info() << "############################### " << A_FUNCINFO; }

void 
ModuleMasterTesterService::
firstRestore() { info() << "############################### " << A_FUNCINFO; }

void 
ModuleMasterTesterService::
firstExit() { info() << "############################### " << A_FUNCINFO; }
  
void 
ModuleMasterTesterService::
lastBuild() { info() << "############################### " << A_FUNCINFO; }

void 
ModuleMasterTesterService::
lastStartInit() { info() << "############################### " << A_FUNCINFO; }

void 
ModuleMasterTesterService::
lastContinueInit() { info() << "############################### " << A_FUNCINFO; }

void 
ModuleMasterTesterService::
lastInit() { info() << "############################### " << A_FUNCINFO; }

void 
ModuleMasterTesterService::
lastComputeLoop() { info() << "############################### " << A_FUNCINFO; }

void 
ModuleMasterTesterService::
lastOnMeshChanged() { info() << "############################### " << A_FUNCINFO; }

void 
ModuleMasterTesterService::
lastRestore() { info() << "############################### " << A_FUNCINFO; }

void 
ModuleMasterTesterService::
lastExit() { info() << "############################### " << A_FUNCINFO; } 

void 
ModuleMasterTesterService::
timeIncrementation()
{
  info() << "############################### " << A_FUNCINFO;
  
  m_global_time = m_global_time() + m_global_deltat();
}

void 
ModuleMasterTesterService::
timeStepInformation(Arcane::Integer nb_loop) 
{
  info()<<  "############################### " << A_FUNCINFO;

  Arcane::Integer precision = FloatInfo<Real>::maxDigit();
  Arcane::Integer digit = precision + 5;

  info(0) << "********************************************************* Time report ***";
  info(0) << "*** Iteration          n° " << Arcane::Trace::Width(8) << m_global_iteration() << " " 
          << "--- Loop               n° " << Arcane::Trace::Width(8) << nb_loop << " ***";
  info(0) << "*** T(n)   = " << Arcane::Trace::Width(digit) 
	  << Arcane::Trace::Precision(precision,m_global_old_time(),true) << " ==> "
          << "T(n+1) = " << Arcane::Trace::Width(digit) 
	  << Arcane::Trace::Precision(precision,m_global_time(),true)     << " ***";
  info(0) << "***                                    DT     = " 
          << Arcane::Trace::Width(digit) << Arcane::Trace::Precision(precision,m_global_deltat(),true)  
          << " ***";
  info(0) << "*************************************************************************";
}

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

using namespace Arcane;
ARCANE_REGISTER_SERVICE_MODULEMASTERTESTER(ModuleMasterTester,ModuleMasterTesterService);

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/
