// -*- C++ -*-
/* Author : desrozis at Mon Oct 27 15:06:07 2014
 * Generated by createNew
 */

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

#include "ArcGeoSim/Tests/ServiceTesters/IServiceTester.h"

#include "ArcGeoSim/Mesh/Geometry/IGeometryMng.h"

#include "AppServiceTester_axl.h"

#include "ArcGeoSim/Appli/AppService.h"

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

class AppServiceTesterService
  : public ArcaneAppServiceTesterObject
{
private:

  class Test
  {
  public:
    Test() {}
    void init() {}
  };

  class Test2
  {
  public:
    Test2(Arcane::Integer i) : m_i(i) { std::cout << this << " Test2::Test2(" << m_i << ");\n"; }
    Test2(const Test2& t) : m_i(t.m_i) { std::cout << this << " Test2::Test2(const Test2&);\n"; }
    ~Test2() { std::cout << this << " Test2::~Test2();\n"; }
    void init() { std::cout << this << " Test2::init() => i = " << m_i << "\n";}
    Arcane::Integer get() const { return m_i; } 
  private:
    Arcane::Integer m_i;
  };

public:
  
  AppServiceTesterService(const Arcane::ServiceBuildInfo & sbi)
    : ArcaneAppServiceTesterObject(sbi) {}
  
  ~AppServiceTesterService() {}
  
public:

  void init() {}

  Arcane::Integer test();

private:
  
  // Peut également être positionné dans des méthodes, fonctions...
  ArcGeoSim::OptionalAppService<IGeometryMng> m_geometry;
};

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

Arcane::Integer 
AppServiceTesterService::
test()
{
  info() << "geometry is available ? : " << m_geometry.isAvailable();
  
  if(m_geometry.isAvailable())
    fatal() << "Error, geometry is not null! please, remove geometry service from use-case";
  
  IAppServiceMng* shared = IAppServiceMng::instance(subDomain()->serviceMng());
  info() << shared->find<IGeometryMng>(false);
  
  if(shared->find<IGeometryMng>(false) != NULL)
    fatal() << "Error, geometry is not null! please, remove geometry service from use-case";
  
  {
    ArcGeoSim::MutableAppService<IGeometryMng> geometry;

    geometry = options()->geometry();

    if(geometry != options()->geometry() ||
       geometry != shared->find<IGeometryMng>(true))
      fatal() << "Error, geometry from options, IAppServiceMng and SharedService are differents";
  }

  info() << "geometry is available ? : " << m_geometry.isAvailable();
  
  if(not m_geometry.isAvailable())
    fatal() << "Error, geometry is null!";
  
  info() << options()->geometry();
  info() << shared->find<IGeometryMng>(true);
  
  if(m_geometry != options()->geometry() ||
     m_geometry != shared->find<IGeometryMng>(true))
    fatal() << "Error, geometry from options, IAppServiceMng and OptionalSharedService are differents";
  
  {
    ArcGeoSim::AppService<IGeometryMng> geometry;
  
    if(geometry != options()->geometry() ||
       geometry != shared->find<IGeometryMng>(true))
      fatal() << "Error, geometry from options, IAppServiceMng and SharedService are differents";
  }
  
  Test t;

  ArcGeoSim::MutableAppService<Test> test;
  
  test = &t;

  info() << &t;
  info() << shared->find<Test>(true);
  
  if(test != &t ||
     test != shared->find<Test>(true))
    fatal() << "Error, test share service, IAppServiceMng and SharedService are differents";
 
  // Enregistrement par constructeur de copie d'objet
  IAppServiceMng* app_services = IAppServiceMng::instance(subDomain()->serviceMng());
  
  app_services->addService(Test2(1234));
  
  ArcGeoSim::AppService<Test2> test2;

  if(test2->get() != 1234)
    fatal() << "Error, test2 share service, value is not correct";
  
  return 1;
}

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

using namespace Arcane;
ARCANE_REGISTER_SERVICE_APPSERVICETESTER(AppServiceTester,AppServiceTesterService);
