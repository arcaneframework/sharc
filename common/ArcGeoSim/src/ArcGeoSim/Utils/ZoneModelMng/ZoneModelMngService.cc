// -*- tab-width: 2; indent-tabs-mode: nil; coding: utf-8-with-signature -*-
//-----------------------------------------------------------------------------
// Copyright 2000-2025 CEA (www.cea.fr) IFPEN (www.ifpenergiesnouvelles.com)
// See the top-level COPYRIGHT file for details.
// SPDX-License-Identifier: Apache-2.0
//-----------------------------------------------------------------------------
#include "ZoneModelMngService.h"
/* Author : havep at Tue Apr 15 16:20:56 2008
 * Generated by createNew
 */

#include <arcane/utils/NotImplementedException.h>
using namespace Arcane;

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

class ModelEnumeratorImpl : public IZoneModelMng::IModelEnumeratorImpl {
private:
  typedef ZoneModelMngService::ModelZoneMap ModelZoneMap;
public:
  ModelEnumeratorImpl(ModelZoneMap & modelZoneMap) 
    : m_model_zone_map(modelZoneMap) { m_iter = m_model_zone_map.begin(); }
  bool hasNext() { return m_iter != m_model_zone_map.end(); }
  void moveNext() { ++m_iter; }
  Integer count() { return m_model_zone_map.size(); }
  IZoneModel * model() { return m_iter->first; }
  ItemGroupCollection itemGroups() { return m_iter->second; }
private:  
  ModelZoneMap & m_model_zone_map;
  ModelZoneMap::iterator m_iter;
};

class ModelTypeEnumeratorImpl : public IZoneModelMng::IModelTypeEnumeratorImpl {
private:
  typedef ZoneModelMngService::ModelMap ModelMap;
  typedef IZoneModelMng::ModelEnumerator ModelEnumerator;
public:
  ModelTypeEnumeratorImpl(ModelMap & modelMap) 
    : m_model_map(modelMap) 
  {
    m_iter = m_model_map.begin();
    ARCANE_ASSERT((m_iter->first==IZoneModel::ModelType()),("Corrupted data structure: default null string not found"));
    moveNext();
  }
  bool hasNext() { return m_iter != m_model_map.end(); }
  void moveNext() { ++m_iter; }
  Integer count() { return m_model_map.size()-1; }
  IZoneModel::ModelType modelType() { return m_iter->first; }
  ModelEnumerator models() { return new ModelEnumeratorImpl(m_iter->second); }
private:
  ModelMap & m_model_map;
  ModelMap::iterator m_iter;
};

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

void 
ZoneModelMngService::
init()
{
  if (m_initialized) return;
  
  m_initialized = true;

  const Integer nbModel = options()->modelZone.size();
  info() << "Initializing ZoneModelMngService with " << nbModel;
  for(Integer imodel=0; imodel < nbModel; ++imodel)
    {
      const CaseOptionsZoneModelMng::CaseOptionModelZoneValue & modelZone = options()->modelZone[imodel];
      IZoneModel * model = modelZone.model();
      // info() <<" geo model[ "<<imodel<<"]= "<<model;
      model->init();
      const Arcane::CaseOptionMultiExtendedT<ItemGroup> & areas = modelZone.area;
      const Integer nbArea = areas.size();
      info() << "Nb Area : " << nbArea;
      if (nbArea>0)
        {
          for(Integer iarea=0;iarea<nbArea;++iarea)
            {
              addModelZone(areas[iarea],model);
              // info() << "geo groupe :"<<areas[iarea].name();
            }
        }
      else
        {
          addModelZone(ItemGroup(),model);
        }
    }

  // Add no name ModelType for default empty ModelMapZone
  m_models[IZoneModel::ModelType()];
}

/*---------------------------------------------------------------------------*/

void 
ZoneModelMngService::
addModelZone(ItemGroup group, IZoneModel * model)
{
  info() << "ZoneModelMngService::add " << group.name() << " " << model << " " << model->modelType();

  ARCANE_ASSERT((m_initialized),("Service used without initialization"));
  ARCANE_ASSERT((model->modelType() != IZoneModel::ModelType()),("Null model type name not allowed"));
  m_models[model->modelType()][model].add(group);
}

bool 
ZoneModelMngService::
removeModelZone(ItemGroup group, IZoneModel * model)
{
  ARCANE_ASSERT((m_initialized),("Service used without initialization"));
//   IZoneModel::ModelType modelType = model->modelType();
//   ModelMap::iterator iModelZone = m_models.find(modelType);
//   if (iModelZone == m_models.end()) return false;
//   ModelZoneMap::iterator iModel = iModelZone->second.find(model);

//   Array<ModelZone<IZoneModel> > & modelArray = imodelArray->second;
  
//   // Remove ONE instance of this (group,model)
//   for(Integer i=0;i<modelArray.size();++i)
//     {
//       ModelZone<IZoneModel> & modelZone = modelArray[i];
//       if (modelZone.model() == model and modelZone.itemGroup() == group)
//         {
//           modelArray.remove(i);
//           return true;
//         }
//     }
  throw NotImplementedException(A_FUNCINFO);
  return false;
}

ItemGroupCollection 
ZoneModelMngService::
getModelGroups(IZoneModel * model)
{
  ARCANE_ASSERT((m_initialized),("Service used without initialization"));
  ModelMap::iterator iModelZone = m_models.find(model->modelType());
  if (iModelZone == m_models.end()) return ItemGroupCollection();
  ModelZoneMap & modelZoneMap = iModelZone->second;
  ModelZoneMap::iterator iGroupModel = modelZoneMap.find(model);
  if (iGroupModel == modelZoneMap.end()) return ItemGroupCollection();
  return iGroupModel->second;
}


IZoneModelMng::ModelTypeEnumerator 
ZoneModelMngService::
getModelTypes()
{
  return new ModelTypeEnumeratorImpl(m_models);
}

IZoneModelMng::ModelEnumerator 
ZoneModelMngService::
getModels(IZoneModel::ModelType model_type)
{
  ARCANE_ASSERT((m_initialized),("Service used without initialization"));
  ModelMap::iterator iModelZone = m_models.find(model_type);
  if (iModelZone == m_models.end()) return new ModelEnumeratorImpl(m_models[IZoneModel::ModelType()]); // empty ModelMapZone
  return new ModelEnumeratorImpl(iModelZone->second);
}

IZoneModel *
ZoneModelMngService::
getSingletonModel(IZoneModel::ModelType model_type)
{
  ARCANE_ASSERT((m_initialized),("Service used without initialization"));
  ModelMap::iterator iModelZone = m_models.find(model_type);
  if (iModelZone == m_models.end()) return NULL; // empty ModelMapZone
  ModelZoneMap & zone_map = iModelZone->second;
  if (zone_map.size() > 1)
    throw FatalErrorException(A_FUNCINFO,"Non unique model requested");
  if (zone_map.empty())
    return NULL;
  return zone_map.begin()->first;
}

void 
ZoneModelMngService::
invalidateModel(IZoneModel * model)
{
  ARCANE_ASSERT((m_initialized),("Service used without initialization"));
  throw NotImplementedException(A_FUNCINFO);
}

void 
ZoneModelMngService::
invalidateGroup(ItemGroup group)
{
  ARCANE_ASSERT((m_initialized),("Service used without initialization"));
  throw NotImplementedException(A_FUNCINFO);
}

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

ARCANE_REGISTER_SERVICE_ZONEMODELMNG(ZoneModelMng,ZoneModelMngService);
