// -*- tab-width: 2; indent-tabs-mode: nil; coding: utf-8-with-signature -*-
//-----------------------------------------------------------------------------
// Copyright 2000-2025 CEA (www.cea.fr) IFPEN (www.ifpenergiesnouvelles.com)
// See the top-level COPYRIGHT file for details.
// SPDX-License-Identifier: Apache-2.0
//-----------------------------------------------------------------------------
#ifndef ARCGEOSIM_UTILS_GRAPHBUILDER_H
#define ARCGEOSIM_UTILS_GRAPHBUILDER_H
/* Author : dipietrd at Thu Nov 15 11:28:20 2007
 * Generated by createNew
 */

#include <vector>
#include <list>
#include <map>
#include <set>
#include <string>

#include <arcane/ArcaneVersion.h>
#include <arcane/utils/ArcaneGlobal.h>
#if (ARCANE_VERSION<11602)
#include <arcane/mesh/DynamicGraph.h>
#else
#if (ARCANE_VERSION <= 30003)
#include <arcane/IGraph.h>
#endif
#include <arcane/utils/Array.h>
#endif

using namespace Arcane;

/*!
  \class LinkDescriptor
  \author Daniele A. Di Pietro <daniele-antonio.di-pietro@ifp.fr>
  \brief Link descriptor
*/
class LinkDescriptor {
 public:
  typedef std::vector<Integer> item_type_vector;
 public:
  LinkDescriptor(const Integer& uid, const Integer& _item_number) 
    : item_types(_item_number), m_uid(uid) {}

  item_type_vector item_types;
  
  inline Integer getItemNumber() const { return item_types.size(); }
  inline const Integer& uniqueId() const { return m_uid; }

 private:
  Integer m_uid;
};

////////////////////////////////////////////////////////////

/*!
  \class LinkData
  \author Daniele A. Di Pietro <daniele-antonio.di-pietro@ifp.fr>
  \brief Link data
*/
class LinkData {
 public:
  typedef std::vector<Integer> item_uid_vector;

 public:
  LinkData(const Integer& _uid, LinkDescriptor ld) 
    : uid(_uid)
    , item_uids(ld.getItemNumber())
    , m_descriptor_uid(ld.uniqueId()) {}

  Integer uid;
  item_uid_vector item_uids;

  inline Integer getItemNumber() const { return item_uids.size(); }
  inline Integer getDescriptorUniqueId() const { return m_descriptor_uid; }
 private:
  Integer m_descriptor_uid;
};

////////////////////////////////////////////////////////////

struct LinkDescriptorComparator {
  struct Smaller {
    bool operator()(const LinkDescriptor& ld1, const LinkDescriptor& ld2) {
      return ld1.uniqueId() < ld2.uniqueId();
    }
  };

  struct Equal {
    bool operator()(const LinkDescriptor& ld1, const LinkDescriptor& ld2) {
      return ld1.uniqueId() == ld2.uniqueId();
    }
  };

  struct IdEqualTo {
    bool operator()(const LinkDescriptor& ld, Integer uid) {
      return ld.uniqueId() == uid;
    }
  };
};

////////////////////////////////////////////////////////////

/*! 
  \class GraphBuilder
  \author Daniele A. Di Pietro <daniele-antonio.di-pietro@ifp.fr>
  \brief Arcane graph builder.

  \GraphBuilder is a helper class intended to facilitate the creation of 
  the Arcane graph.
  The creation of the graph requires three steps:
  * the definition of the link descriptors which characterize the links.
  A \LinkDescriptor is defined by the number of items connected by the link
  together with their type;
  * the addition of the links.
  A link is created by passing to \addLink the corresponding \LinkData;
  * the construction of the graph, which is carried out by the member \build.
  */
class GraphBuilder {
 public:
  struct Warning {
    std::string msg;
    Warning(const std::string& _msg) : msg(_msg) {}
  };

  struct Error {
    std::string msg;
    Error(const std::string& _msg) : msg(_msg) {}
  };

 public:
  typedef std::set<LinkDescriptor, LinkDescriptorComparator::Smaller> descriptor_set;
  typedef std::list<LinkData> link_list;
  typedef std::map<Integer, link_list> descriptor2link_map;

 public:
  //! Default constructor
  GraphBuilder() {}
  //! Destructor
  virtual ~GraphBuilder() {};

 public:
#ifndef USE_ARCANE_V3
  //! Add one link descriptor
  void addLinkDescriptor(const LinkDescriptor& ld);
  //! Add one link
  void addLink(const LinkData& l);
  /*! Build the graph.
    
  The graph description is provided in Arcane as an array of \Int64.
  The aim of this member is to build it from the information provided
  by the user.
  The array is composed of two parts:
  * a headline, where the types of links appearing in the graph are described.
  A link description is composed of the number of items connected by the link
  together with their types.
  The following format is used:
  # of descriptors 
  | # of items in descriptor 1 | type of item_1 | type of item_2 | ... | type of item_n1
  | # of items in descriptor 2 | type of item_1 | type of item_2 | ... | type of item_n2
  ...
  * a body, containing the groups of links.
  The following format is used
  # of groups
  | # of links in group 1 | descriptor's progressive number | link_1 | link_2 | ... | link_n1
  | # of links in group 2 | descriptor's progreesive number | link_1 | link_2 | ... | link_n2
  ...
  A link is simply described by the (list of the) unique ids of the connected items.
  */
#if (ARCANE_VERSION<11602)
  void build(Arcane::mesh::DynamicGraph* graph);
#else
  void build(Arcane::IGraph* graph);
#endif
 private:
  //! Link descriptors
  descriptor_set m_descriptors;
  //! Links
  descriptor2link_map m_links;
#endif
};


#endif /* ARCGEOSIM_UTILS_GRAPHBUILDER_H */
