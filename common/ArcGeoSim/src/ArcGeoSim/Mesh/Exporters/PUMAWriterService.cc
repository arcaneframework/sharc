// -*- tab-width: 2; indent-tabs-mode: nil; coding: utf-8-with-signature -*-
//-----------------------------------------------------------------------------
// Copyright 2000-2025 CEA (www.cea.fr) IFPEN (www.ifpenergiesnouvelles.com)
// See the top-level COPYRIGHT file for details.
// SPDX-License-Identifier: Apache-2.0
//-----------------------------------------------------------------------------
// -*- C++ -*-
/* Author : pajon at Thu Jul 31 10:41:12 2014
 * Generated by createNew
 */

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

// Interface du service
#include <arcane/IPostProcessorWriter.h>

#include "arcane/BasicService.h"
#include <arcane/VariableCollection.h>
#include <arcane/utils/Collection.h>
#include <arcane/utils/List.h>
#include <arcane/ItemGroup.h>
#include <arcane/utils/Enumerator.h>
#include <arcane/PostProcessorWriterBase.h>
#include <arcane/IIOMng.h>
#include <arcane/IParallelMng.h>
#include <arcane/ArcaneVersion.h>

#include "ArcGeoSim/Mesh/Utils/VariableUtils.h"
#include "ArcGeoSim/Mesh/Exporters/PUMA/PUMADataWriter.h"
#include "ArcGeoSim/Mesh/Utils/IXMTools/IXMTools.h"

#include "PUMAWriter_axl.h"


/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

class PUMAWriterService
  : public ArcanePUMAWriterObject
{
public:

  
  /** Constructeur de la classe */
  PUMAWriterService(const Arcane::ServiceBuildInfo & sbi)
    : ArcanePUMAWriterObject(sbi) {}

  /** Destructeur de la classe */
  ~PUMAWriterService() {}
  
  virtual void build()
  	{
  		m_file_created = false;
  		m_event_number = 0;
  	}

  	//! Aucun dataWriter est associe a cet ecrivain
  	virtual IDataWriter* dataWriter() { return m_writer; }

  	//! Notifie qu'une sortie va �tre effectu�e avec les param�tres courants.
  	virtual void notifyBeginWrite()
  	{
  		Trace::Setter trace(traceMng(),"PUMAWriter");
  		debug() << "NotifyBeginWrite()";
  		_setFileName();
  		ItemGroupCollection groups = PostProcessorWriterBase::groups();
  		VariableCollection variables = PostProcessorWriterBase::variables();
  		Integer index = PostProcessorWriterBase::times().size();
  		info() << "NB_VARS=" << variables.count() << " NB_TIMES=" << index;

  		info() << "NB_VARS=" << variables.count() << " baseDirectoryName=" << PostProcessorWriterBase::baseDirectoryName();

  		m_writer = new PUMADataWriter(subDomain()->defaultMesh(),PostProcessorWriterBase::baseDirectoryName(), m_event_number);


  		// Prepare l'ecriture les fichiers XML/HDF contenant les meta-donnees et les donnees (mesh/properties)
  		m_writer->beginMeshWrite(m_base_file_name);

  		// Ecrit le maillage et certaines proprietes

  		m_writer->writeEventToFile();

  	}

  	//! Notifie qu'une sortie vient d'�tre effectu�e.
  	virtual void notifyEndWrite()
  	{
  	  Trace::Setter trace(traceMng(),"PUMAWriter");
  	  debug() << "NotifyEndWrite()";

  		// Finalize write (dump to file)
  		m_writer->endMeshWrite();

  		// Increment event_number
  		++m_event_number;

  		// Event global file is created
  		m_file_created = true;

  		delete m_writer;
  		m_writer = 0;
  	}

  	//! Ferme l'�crivain. Apr�s fermeture, il ne peut plus �tre utilis�
  	virtual void close() {
		// delete m_output_doc;
	}

  private:
  	PUMADataWriter* m_writer;
  	String m_base_file_name;
  	Integer m_event_number;
  	bool m_is_master;
  	bool m_file_created;


  private:

  	void _setFileName()
  	{
  		const String& base_fname=  options()->baseFileName();
  		PostProcessorWriterBase::setBaseFileName(base_fname);
  		m_base_file_name = baseFileName();
  		if (m_base_file_name.null())
  			m_base_file_name = "data";
  	}
};

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

using namespace Arcane;
ARCANE_REGISTER_SERVICE_PUMAWRITER(PUMAWriter,PUMAWriterService);
