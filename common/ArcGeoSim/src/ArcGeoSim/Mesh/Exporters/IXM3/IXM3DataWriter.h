// -*- C++ -*-
#ifndef ARCGEOSIM_MESH_EXPORTERS_IFPDATAWRITER_H
#define ARCGEOSIM_MESH_EXPORTERS_IFPDATAWRITER_H
/* Author : dechaiss at Wed Nov  3 11:03:03 2010
 * Generated by createNew
 */
#include <arcane/ArcaneVersion.h>
#include <arcane/DomUtils.h>
#include <arcane/IDataWriter.h>
#include <arcane/utils/TraceAccessor.h>
#include <arcane/utils/ITraceMng.h>
#include <arcane/VariableCollection.h>
#include <arcane/IRessourceMng.h>
#include <arcane/IIOMng.h>
#include <arcane/PostProcessorWriterBase.h>
#include <arcane/CommonVariables.h>
#include <arcane/IXmlDocumentHolder.h>
#include <arcane/IParallelMng.h>
#include <arcane/ISubDomain.h>
#include <arcane/IMesh.h>

using namespace Arcane;

class IXM3DataWriter : public IDataWriter
{
public:
  
  /** Constructeur de la classe */
  IXM3DataWriter(PostProcessorWriterBase* post_pro_base,IMesh* mesh,
                 const Integer event_number, const bool event_initialized,
                 const bool want_face_aid);

  /** Destructeur de la classe */
  virtual ~IXM3DataWriter();
  
public:

  //! Add current event to global events file
  void beginWrite(const VariableCollection& vars);

  //! Write the data \a data of \a var variable in the current event doc
  void write(IVariable* var,IData* data);

  //! Write current event doc and free memory
  void endWrite();

  //! Set meta data (xml info created by VariableMng node <arcane-checkpoint-metadata>. Stored but not used at present.
  void setMetaData(const String& meta_data) {m_meta_data = meta_data;}

private:
  Arcane::PostProcessorWriterBase* m_post_pro_base;
  Arcane::IMesh* m_mesh;
  Arcane::ITraceMng* m_trace_mng;
  Arcane::IRessourceMng* m_ressource_mng;
  Arcane::IIOMng* m_io_mng;
  Arcane::IXmlDocumentHolder* m_events_doc;
  Arcane::IXmlDocumentHolder* m_current_event_doc;
  String m_events_filename;
  const Integer m_event_number; // Given by Post processor. Cannot be modified in writer
  const bool m_events_initialized; // Given by Post processor. Cannot be modified in writer
  CommonVariables m_common_variables;
  String m_default_event_filename;
  Arcane::IVariable* m_var;
  Arcane::IData* m_data;
  Arcane::ItemGroup m_group; //!<Groupe de la propri�t�. Devrait pouvoir �tre enlev� lorsque seront utilis�es les variables partielles.
  String m_meta_data; // Variables infos created by VariableMng
  // Parallel
  IParallelMng* m_parallel_mng;
  bool m_is_parallel;
  bool m_is_master;
  // Mesh format supported version
  String m_supported_version;
  // Face abstract ids are available
  bool m_has_face_aids;
  struct FaceOfInterestData
  {
    bool m_has_face_property;
    Arcane::String m_all_face_ids;
    Arcane::String m_all_face_node_number;
    Arcane::String m_all_face_node_uids;
  };

  //! Structures de copies uniformis�es sur les Array
  class InternalArrayRegister;
  InternalArrayRegister * m_array_register;

  //! Mots clefs 'magiques'
  const String m_magic_intern_keyword, m_magic_comment_keyword;

  //! Create global Events doc info (only once)
  void _createEventsDoc();

  //! Load global Events doc if already created
  void _loadEventsDoc();

  //! Create current event tag in Events doc
  void _updateEventsDoc();

  //! Create current event doc
  void _createCurrentEventDoc(const FaceOfInterestData& face_of_interest_data);

  //! Create <property> node
  void _createPropertyNode(const String& support, const String& values);

  //! Get Property support from IData
  const String _getPropertySupport();

  //! Get Property values from IData
  const String _getPropertyValues();

  //! Get Property group. For face variable, may be reduced to m_face_group_name group. Otherwise variable group is taken.
  void _getPropertyGroup();

  //! Get typed property values; depends on value type
  template<typename T> const String _getValuesT();

  //! Handle distributed memory data
  template<typename T> void _getParallelWantedDataT(SharedArray<T>& array);
#if ARCANE_VERSION > 30003
  Arcane::Ref<IData> _getLocalItemsData() const;
  Arcane::Ref<IData> _createPartialIData(IData* const data, Int32ConstArrayView ids) const;
#else
  IData* _getLocalItemsData() const;
  IData* _createPartialIData(IData* const data, Int32ConstArrayView ids) const;
#endif
  //! Get global events file name
  const String _eventsFileName() const;

  //! Get current event name (path included)
  const String _currentEventFileName() const;

  //! Get data node name from data type name
  const String _dataNodeName(const String& data_type) const;

  //! Get output time (corresponds to end of current event time. Is stored in PostProcessorBase)
  const Real _getOutputTime() const
  {RealConstArrayView times = m_post_pro_base->times();return *(times.end()- 1);}

  //! Create Face description output (needed for the correspondence abstract_id to unique ids
  void _createFacesTag(Arcane::XmlNode& event_root_node,const FaceOfInterestData& face_of_interest_data);
  void _getFaceOfInterestData(FaceOfInterestData& face_of_interest_data, const Arcane::VariableCollection& vars);
  void _fillFaceTagArrays(Array<Int64>& face_ids, Array<Integer>& node_number, Array<Int64>& node_ids);
  void _registerFaceTagArrays(FaceOfInterestData& face_of_interest_data, const Array<Int64>& face_ids, const Array<Integer>& node_number, const Array<Int64>& node_ids) const;

  //! Write Xml document using delegation with magic tags
  bool _magicWriteXmlFile(Arcane::IXmlDocumentHolder* xml_doc_holder, const Arcane::String & filename);

  //! Write Xml node using delegation with magic tags
  bool _magicWriteXmlNode(std::ostream & o, const dom::Node & node, const String & indent);
  bool _writeNodeChildren(std::ostream& o,const dom::Node& node, const String & indent);
  String _collapseWhiteString(const String & str);
};

#endif /* ARCGEOSIM_MESH_EXPORTERS_IFPDATAWRITER_H */
