// -*- C++ -*-
#ifndef ARCGEOSIM_MESH_EXPORTERS_PUMADataWriter_H
#define ARCGEOSIM_MESH_EXPORTERS_PUMADataWriter_H
/* Author : dechaiss at Wed Nov  3 11:03:03 2010
 * Generated by createNew
 */

#include <arcane/DomUtils.h>
#include <arcane/IDataWriter.h>
#include <arcane/utils/TraceAccessor.h>
#include <arcane/utils/ITraceMng.h>
#include <arcane/VariableCollection.h>
#include <arcane/IRessourceMng.h>
#include <arcane/IIOMng.h>
#include <arcane/PostProcessorWriterBase.h>
#include <arcane/CommonVariables.h>
#include <arcane/IParallelMng.h>
#include <arcane/ISubDomain.h>
#include <arcane/IMesh.h>

#include "arcane/utils/ArcanePrecomp.h"
#include "arcane/utils/Iostream.h"
#include "arcane/utils/StdHeader.h"
#include "arcane/utils/HashTableMap.h"
#include "arcane/utils/ValueConvert.h"
#include "arcane/utils/ScopedPtr.h"
#include "arcane/utils/ITraceMng.h"
#include "arcane/utils/String.h"
#include "arcane/utils/IOException.h"
#include "arcane/utils/PlatformUtils.h"
#include "arcane/utils/Collection.h"
#include "arcane/utils/Enumerator.h"
#include "arcane/utils/NotImplementedException.h"
#include "arcane/utils/Real3.h"

#include "arcane/Factory.h"
#include "arcane/FactoryService.h"
#include "arcane/IMainFactory.h"
#include "arcane/IMeshReader.h"
#include "arcane/ISubDomain.h"
#include "arcane/IMesh.h"
#include "arcane/IItemFamily.h"
#include "arcane/Item.h"
#include "arcane/ItemEnumerator.h"
#include "arcane/VariableTypes.h"
#include "arcane/IVariableAccessor.h"
#include "arcane/IParallelMng.h"
#include "arcane/IIOMng.h"
#include "arcane/IMeshUtilities.h"
#include "arcane/IMeshWriter.h"
#include "arcane/BasicService.h"

#include "arcane/AbstractService.h"

#include "arcane/ICaseMng.h"
#include "arcane/ICaseDocument.h"
#include "arcane/CaseNodeNames.h"

#include <arcane/utils/ITraceMng.h>


#include "ArcGeoSim/Mesh/Utils/IXMTools/IXMItemConnections.h"
#include "ArcGeoSim/Mesh/Utils/ArrayMng.h"
#include "ArcGeoSim/Mesh/Utils/ArrayMngT.h"
#include "ArcGeoSim/Mesh/Utils/VariableView.h"
#include "ArcGeoSim/Utils/Utils.h"

#include <iostream>
#include <fstream>

using namespace std;


/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/
ARCANE_BEGIN_NAMESPACE
/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/


class IfpVtkFileCopy
{
public:
  static const int BUFSIZE = 10000;
public:
  enum LINE_TYPE { OPTIONAL_LINE, MANDATORY_LINE };
public:
  IfpVtkFileCopy(istream* stream) : m_stream(stream) {}
  bool isThereAnotherLine();
  const char* getNextLine(LINE_TYPE line_type);
  const char* getNextLine();
  Real getReal();
  Integer getInteger();
  void checkString(const String& current_value,const String& expected_value);
  void checkString(const String& current_value,
                   const String& expected_value1,
                   const String& expected_value2);
  void checkString(const String& current_value,
                   const String& expected_value1,
                   const String& expected_value2,
                   const String& expected_value3,
                   const String& expected_value4,
                   const String& expected_value5,
                   const String& expected_value6);
  static bool isEqualString(const String& current_value,const String& expected_value);

  bool isEnd(){ (*m_stream) >> ws; return m_stream->eof(); }
private:
  istream* m_stream;
  char m_buf[BUFSIZE];
};


class PUMADataWriter : public IDataWriter
{
public:

  /** Constructeur de la classe */
  PUMADataWriter(IMesh* mesh,const String& directory_name,const Integer event_number);

  /** Destructeur de la classe */
  virtual ~PUMADataWriter();

public:

  //! Add current event to global events file
  void beginMeshWrite(const String& file_name);
  //!
  void writeEventToFile();
  //!
  void endMeshWrite();

  //! Ecrivain des variables : appel par IVariableMng (beginWrite(), write(ivar,idata), endWrite())
  //!
  void beginWrite(const VariableCollection& vars);
  //!
  void endWrite(){}
  //! Positionne les infos des méta-données
  //!
  void setMetaData(const String& meta_data){}
  //! Ecrit les données \a data de la variable \a var
  //!
  void write(Arcane::IVariable* var,Arcane::IData* data);

  //!
  void _getArraySize(Arcane::IVariable * var, Arcane::Integer& array_size);

private:
  IMesh* m_mesh;
  String m_directory_name;
  Arcane::ITraceMng* m_trace_mng;
  IRessourceMng* m_ressource_mng;
  Arcane::IIOMng* m_io_mng;

  const Integer m_event_number; // Given by Post processor. Cannot be modified in writer

  String m_output_directory;
  String m_output_file;
  String m_output_base_file;

  Arcane::VariableCollection  puma_variables;

  class Grille
  {
  public:
      String NXYZ;
      String SUBSTITUE;
      String DX,DY,DZ;
      String ZTOP;
      RealUniqueArray poros;
      RealUniqueArray perm;
      Int32UniqueArray zonation;
      map<String,RealUniqueArray> realproperties;
  };

  map<String, Grille> map_subgrids;

  int m_count_subgrid[8];

  Real m_dx[8];
  Real m_dy[8];
  Real m_dz[8];

  enum eMeshType
  {
      VTK_MT_Unknown,
      VTK_MT_StructuredGrid,
      VTK_MT_DistStructuredGrid,
      VTK_MT_StructuredGraph,
      VTK_MT_StructuredDualGrid,
      VTK_MT_UnstructuredGrid
  };

  void createPUMAFile(const String& file_name);

  const String baseFileName() const;

  void recursiveWriteFirstLevel(const Real3 min, const Real3 max, const Integer ni, const Integer nj, const Integer nk, const Integer meshNbNodes, const Int64SharedArray nodesUniqueIDs, const SharedArray<Real3> coords);

  bool _readMeshDimensions(const String& file_name, Integer & nb_node_x, Integer & nb_node_y, Integer & nb_node_z, Real3 & minimum, Real3 & maximum);

  void recursiveWrite(const String parentGrid, Real3 & parentSize, const Real cellZTop, const Cell cell, const Integer level, const Integer i, const Integer j, const Integer k, const Integer meshNbNodes, const Int64SharedArray nodesUniqueIDs, const SharedArray<Real3> coords);

  void findIndices(const Cell cell0, const Cell cell1,  Real3 & size, Real & zTop, Integer & i, Integer & j, Integer & k, const Integer meshNbNodes, const Int64SharedArray nodesUniqueIDs, const SharedArray<Real3> coords);

  void findPosition(const Real3 min, const Real3 max, const Integer ni , const Integer nj ,const Integer nk ,const Real3 coord, Integer & i, Integer & j, Integer & k);


};

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

ARCANE_END_NAMESPACE

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

#endif /* ARCGEOSIM_MESH_EXPORTERS_PUMADataWriter_H */
