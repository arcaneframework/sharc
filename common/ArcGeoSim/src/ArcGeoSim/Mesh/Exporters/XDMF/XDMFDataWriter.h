// -*- C++ -*-
#ifndef ARCGEOSIM_MESH_EXPORTERS_XDMFDATAWRITER_H
#define ARCGEOSIM_MESH_EXPORTERS_XDMFDATAWRITER_H
/* Author : dechaiss at Wed Nov  3 11:03:03 2010
 * Generated by createNew
 */

#include <arcane/DomUtils.h>
#include <arcane/IDataWriter.h>
#include <arcane/utils/TraceAccessor.h>
#include <arcane/utils/ITraceMng.h>
#include <arcane/VariableCollection.h>
#include <arcane/IRessourceMng.h>
#include <arcane/IIOMng.h>
#include <arcane/PostProcessorWriterBase.h>
#include <arcane/CommonVariables.h>
#include <arcane/IXmlDocumentHolder.h>
#include <arcane/IParallelMng.h>
#include <arcane/ISubDomain.h>
#include <arcane/IMesh.h>

#include "arcane/utils/ArcanePrecomp.h"
#include "arcane/utils/Iostream.h"
#include "arcane/utils/StdHeader.h"
#include "arcane/utils/HashTableMap.h"
#include "arcane/utils/ValueConvert.h"
#include "arcane/utils/ScopedPtr.h"
#include "arcane/utils/ITraceMng.h"
#include "arcane/utils/String.h"
#include "arcane/utils/IOException.h"
#include "arcane/utils/PlatformUtils.h"
#include "arcane/utils/Collection.h"
#include "arcane/utils/Enumerator.h"
#include "arcane/utils/NotImplementedException.h"
#include "arcane/utils/Real3.h"

#include "arcane/Factory.h"
#include "arcane/FactoryService.h"
#include "arcane/IMainFactory.h"
#include "arcane/IMeshReader.h"
#include "arcane/ISubDomain.h"
#include "arcane/IMesh.h"
#include "arcane/IItemFamily.h"
#include "arcane/Item.h"
#include "arcane/ItemEnumerator.h"
#include "arcane/VariableTypes.h"
#include "arcane/IVariableAccessor.h"
#include "arcane/IParallelMng.h"
#include "arcane/IIOMng.h"
#include "arcane/IXmlDocumentHolder.h"
#include "arcane/XmlNodeList.h"
#include "arcane/XmlNode.h"
#include "arcane/IMeshUtilities.h"
#include "arcane/IMeshWriter.h"
#include "arcane/BasicService.h"

#include "arcane/std/Hdf5Utils.h"

#include "arcane/AbstractService.h"

#define XDMF_USE_ANSI_STDLIB
#include "arcane/ios/IosXdmf.h"

#include "ArcGeoSim/Mesh/Utils/MeshUtils.h"
#include "ArcGeoSim/Mesh/Utils/IXMTools/IXMItemConnections.h"


#include "XDMFDataNode.h"



/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/
ARCANE_BEGIN_NAMESPACE
/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

class XDMFDataWriter
: public IDataWriter
#ifdef USE_ARCANE_V3
, public ArcGeoSim::DualGraphBasedModel
#endif
{
public:

  /** Constructeur de la classe */
  XDMFDataWriter(IMesh* mesh, IXmlDocumentHolder* output_doc,const String& directory_name,const Integer event_number, bool event_initialized);

  /** Destructeur de la classe */
  virtual ~XDMFDataWriter();

public:

  //! Add current event to global events file
  void beginMeshWrite(const String& file_name, const String& format, ItemGroupCollection& groups, VariableCollection& vars);
  //!
  void writeMeshToFile(const String& file_name);
  //!
  void writeEventToFile(const String& file_name,const Real& begin_time, const Real& end_time, const Integer& event_number);
  //!
  void endMeshWrite();

  //! Ecrivain des variables : appel par IVariableMng (beginWrite(), write(ivar,idata), endWrite())
  //!
  void beginWrite(const VariableCollection& vars);
  //!
  void endWrite(){}
  //! Positionne les infos des m�ta-donn�es
  //!
  void setMetaData(const String& meta_data){}
  //! Ecrit les donn�es \a data de la variable \a var
  //!
  void write(Arcane::IVariable* var,Arcane::IData* data);

private:
  IMesh* m_mesh;
  String m_directory_name;
  Arcane::ITraceMng* m_trace_mng;
  IRessourceMng* m_ressource_mng;
  Arcane::IIOMng* m_io_mng;

  const Integer m_event_number; // Given by Post processor. Cannot be modified in writer
  const bool m_events_initialized; // Given by Post processor. Cannot be modified in writer
  String m_default_event_filename;
  String m_supported_version;
  bool m_save_increment_mesh;

  bool m_write_initial_grid_properties;

  Real m_begin_time;

  ArcGeoSim::ItemConnectionMng m_connection_mng;

  XmlNode m_xdmf_doc;

  //XmlNode* m_xmf_mesh;
  // XmlNode* m_xmf_event;
  // String m_file_name;

  XmlNode m_initial_grid_node;
  XmlNode m_current_grid_node;
  //XmlNode m_initial_grid_properties_node;
  //XmlNode m_current_grid_properties_node;

  String m_hdf_path; // relative to xmf file path
  String m_format;

  ItemGroupCollection m_groups;

  String m_output_directory;
  String m_output_file;
  String m_output_base_file;

  IXmlDocumentHolder* m_output_doc;

  void buildMeshIncrement(const String& format, const bool& save_it);

  void createXdmfFile(const String& file_name);
  //! create Xdmf doc
  void createXdmfDoc();
  //! Load Xdmf doc if already created
  void loadXdmfDoc();

  //! Update Ixm doc by incrementing events and properties
  void updateXdmfDoc(const Real& begin_time, const Real& end_time, const Integer& event_number);

  const String baseFileName() const;

  const String xmfFileName() const;

  const String hdfFileName() const;

  void _switchXmfType(Integer arc_type, Array<Integer>& arcConnectivityArray);

};

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

ARCANE_END_NAMESPACE

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

#endif /* ARCGEOSIM_MESH_EXPORTERS_XDMFDATAWRITER_H */
