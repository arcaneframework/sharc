// -*- tab-width: 2; indent-tabs-mode: nil; coding: utf-8-with-signature -*-
//-----------------------------------------------------------------------------
// Copyright 2000-2025 CEA (www.cea.fr) IFPEN (www.ifpenergiesnouvelles.com)
// See the top-level COPYRIGHT file for details.
// SPDX-License-Identifier: Apache-2.0
//-----------------------------------------------------------------------------
// -*- C++ -*-
/* Author : pajon at Thu Jul 31 10:41:12 2014
 * Generated by createNew
 */

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

// Interface du service
#include <arcane/IPostProcessorWriter.h>

#include "arcane/BasicService.h"
#include <arcane/VariableCollection.h>
#include <arcane/utils/Collection.h>
#include <arcane/utils/List.h>
#include <arcane/ItemGroup.h>
#include <arcane/utils/Enumerator.h>
#include <arcane/PostProcessorWriterBase.h>
#include <arcane/IIOMng.h>
#include <arcane/IParallelMng.h>
#include <arcane/ArcaneVersion.h>
#include "ArcGeoSim/Mesh/Utils/MeshUtils.h"
#include "ArcGeoSim/Mesh/Utils/VariableUtils.h"
#include "ArcGeoSim/Mesh/Exporters/XDMF/XDMFDataWriter.h"
#include "ArcGeoSim/Mesh/Utils/IXMTools/IXMTools.h"

#include "XDMFWriter_axl.h"

enum eIXMDataFormat
{
  hdf, split_hdf, xml
};

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

class XDMFWriterService 
  : public ArcaneXDMFWriterObject
{
public:

  
  /** Constructeur de la classe */
  XDMFWriterService(const Arcane::ServiceBuildInfo & sbi) 
    : ArcaneXDMFWriterObject(sbi) {}

  /** Destructeur de la classe */
  ~XDMFWriterService() {}
  
  virtual void build()
  	{
  		m_ixm_created = false;
  		m_event_number = 0;
  		IRessourceMng* ressource_mng = mesh()->subDomain()->ressourceMng();
  		m_output_doc = ressource_mng->createXmlDocument();
  	}

  	//! Aucun dataWriter est associe a cet ecrivain
  	virtual IDataWriter* dataWriter() { return m_writer; }

  	//! Notifie qu'une sortie va �tre effectu�e avec les param�tres courants.
  	virtual void notifyBeginWrite()
  	{
  		Trace::Setter trace(traceMng(),"XDMFWriter");
  		debug() << "NotifyBeginWrite()";
  		_setFileName();
  		ItemGroupCollection groups = PostProcessorWriterBase::groups();
  		VariableCollection variables = PostProcessorWriterBase::variables();
  		Integer index = PostProcessorWriterBase::times().size();
  		info() << "NB_VARS=" << variables.count() << " NB_TIMES=" << index;

  		info() << "NB_VARS=" << variables.count() << " baseDirectoryName=" << PostProcessorWriterBase::baseDirectoryName();

  		m_writer = new XDMFDataWriter(subDomain()->defaultMesh(),m_output_doc,PostProcessorWriterBase::baseDirectoryName(), m_event_number, m_ixm_created);
  		// const String format= ArcGeoSim::IXMTools::ixmDataFormatName(options()->format());

  		String format;

  		switch ( options()->format() )
  		{
  		case hdf:
  			format = "HDF";
  			break;
  		case split_hdf:
  			format = "HDF";
  			break;
  		case xml:
  			format = "XML";
  			break;
  		}

  		info() << "FORMAT: " << format;

  		// Prepare l'ecriture les fichiers XML/HDF contenant les meta-donnees et les donnees (mesh/properties)
  		m_writer->beginMeshWrite(m_base_file_name,format,groups,variables);

  		// Ecrit le maillage. L'ecriture des proprietes (IXMMeshWriter::write(IVariable*, IData*) est declenchee par Arcane::IVariableMng*
  		// (ce qui lui permet eventuellement de filtrer les proprietes ecrites).
  		RealConstArrayView my_times = times();
  		if(!m_ixm_created)
  		{
  			if (options()->writeMesh()) m_writer->writeMeshToFile(m_base_file_name);
  			m_writer->writeEventToFile(m_base_file_name,my_times[m_event_number], my_times[m_event_number], m_event_number);
  		}
  		else
  			m_writer->writeEventToFile(m_base_file_name,my_times[m_event_number], my_times[m_event_number], m_event_number);


  	}

  	//! Notifie qu'une sortie vient d'�tre effectu�e.
  	virtual void notifyEndWrite()
  	{
  	  Trace::Setter trace(traceMng(),"XDMFWriter");
  	  debug() << "NotifyEndWrite()";

  		// Finalize write (dump to file)
  		m_writer->endMeshWrite();

  		// Increment event_number
  		++m_event_number;

  		// Event global file is created
  		m_ixm_created = true;

  		delete m_writer;
  		m_writer = 0;
  	}

  	//! Ferme l'�crivain. Apr�s fermeture, il ne peut plus �tre utilis�
  	virtual void close() {
		// delete m_output_doc;
	}

  private:
  	XDMFDataWriter* m_writer;
  	String m_base_file_name;
  	Integer m_event_number;
  	bool m_is_master;
  	bool m_ixm_created;
	IXmlDocumentHolder* m_output_doc;


  private:

  	void _setFileName()
  	{
  		const String& base_fname=  options()->baseFileName();
  		PostProcessorWriterBase::setBaseFileName(base_fname);
  		m_base_file_name = baseFileName();
  		if (m_base_file_name.null())
  			m_base_file_name = "data";
  	}
};

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

using namespace Arcane;
ARCANE_REGISTER_SERVICE_XDMFWRITER(XDMFWriter,XDMFWriterService);
