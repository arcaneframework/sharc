// -*- C++ -*-
#ifndef ARCGEOSIM_ARCGEOSIM_MESH_UTILS_IXMTOOLS_IXMMESHREADERTOOLS_H
#define ARCGEOSIM_ARCGEOSIM_MESH_UTILS_IXMTOOLS_IXMMESHREADERTOOLS_H
/* Author : dechaiss at Mon Jul 23 14:41:28 2012
 * Generated by createNew
 */

#include <boost/shared_ptr.hpp>

#include <arcane/XmlNode.h>
#include <arcane/IXmlDocumentHolder.h>
#include <arcane/utils/ValueConvert.h>
#include <arcane/utils/FatalErrorException.h>
#include <arcane/utils/StringBuilder.h>
#include <arcane/utils/PlatformUtils.h>

#include "ArcGeoSim/Utils/ArcGeoSim.h"
//#include "ArcGeoSim/Mesh/Utils/IXMTools/IIXMEvolutiveMeshReader.h"
#include "ArcGeoSim/Utils/HdfReader.h"

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

BEGIN_ARCGEOSIM_NAMESPACE

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/
// IXM reader tool

/*---------------------------------------------------------------------------*/
/*
struct IXMMeshIncrementXmlNode
{
  IXMMeshIncrementXmlNode(const IIXMEvolutiveMeshReader::IXMMeshIncrementInfo& mesh_increment_info)
    : xmldoc_holder(NULL)
    , mesh_increment_info(mesh_increment_info){}
  ~IXMMeshIncrementXmlNode() {if (xmldoc_holder) delete xmldoc_holder;}
  //! intern events representation: topology, geometry and property holder
  typedef boost::shared_ptr<Arcane::XmlNode > XmlNode_ptr;
  XmlNode_ptr topology_node;
  XmlNode_ptr geometry_node;
  XmlNode_ptr property_node;
  Arcane::IXmlDocumentHolder* xmldoc_holder;
  IIXMEvolutiveMeshReader::IXMMeshIncrementInfo mesh_increment_info;
};
*/
/*---------------------------------------------------------------------------*/

inline Arcane::String hdfFileName(const Arcane::String& base_file_name, const Arcane::String& mesh_file_directory)
{
  Arcane::String filename;
  // New convention (ASIM192): path in ixm relative to mesh directory => need to concat filename with mesh directory.
  // Test done in the following to ensure compatibility with previous system (< ASIM192, ie filename in ixm is relative to run directory).
  if (Arcane::platform::isFileReadable(base_file_name)) filename = base_file_name; // Compatibility before ASIM192
  else filename = Arcane::String::concat(mesh_file_directory,'/',base_file_name); // New convention ASIM192
  return filename;
}

inline void fileNameAndPositionFromHdfString(const Arcane::String& data_string, const Arcane::String& mesh_directory_name, Arcane::String & file_name, Arcane::String& file_position)
{
	Arcane::StringSharedArray file_info;
	Arcane::String::collapseWhiteSpace(data_string).split(file_info,':');
	file_name = ArcGeoSim::hdfFileName(file_info[0],mesh_directory_name);
	file_position = file_info[1];
}

/*---------------------------------------------------------------------------*/

template <typename DataType>
class IXMDataNodeReader
{
public:
  IXMDataNodeReader(const Arcane::XmlNode& data_parent_node,
                    const Arcane::String& error_message,
                    const Arcane::String& directory_name,
                    const bool data_node_can_be_empty = false)
    : m_error_message(error_message)
    , m_directory_name(directory_name)
  {
    ARCANE_ASSERT((!data_parent_node.child("data").null()),("Given node contains no data, exiting."))
    Arcane::XmlNode data_node = data_parent_node.child("data");
    Arcane::String format = data_node.attrValue("format");
    if (format == "xml") _readXmlData(data_node, data_node_can_be_empty);
    else _readHdf5Data(data_node);
  }
  virtual ~IXMDataNodeReader(){}


public:
  typedef Arcane::SharedArray<DataType> DataArray;

  DataArray read(){return m_data;}


private:
  Arcane::String m_error_message;
  DataArray m_data;
  Arcane::String m_directory_name;

  void _readXmlData(const Arcane::XmlNode& data_node, const bool data_node_can_be_empty)
  {
    Arcane::String data_string = data_node.value();
    if (data_string.empty()) {
      if (data_node_can_be_empty) return;
      else throw Arcane::FatalErrorException(A_FUNCINFO,String::concat("Data node is empty ",m_error_message));
    }
    bool error = Arcane::builtInGetValue(m_data,data_string);
    if (error) throw Arcane::FatalErrorException(A_FUNCINFO,m_error_message);
  }

  void _readHdf5Data(const Arcane::XmlNode& data_node)
  {
    Arcane::StringSharedArray file_info;
    Arcane::String::collapseWhiteSpace(data_node.value()).split(file_info,':');
    Arcane::String file_position = file_info[1];
    Arcane::String filename = hdfFileName(file_info[0],m_directory_name);
    HdfReader::read(m_data,filename,file_position);
  }
};

typedef IXMDataNodeReader<Arcane::Int64> IXMInt64DataNodeReader;
typedef IXMDataNodeReader<Arcane::Int32> IXMInt32DataNodeReader;
typedef IXMDataNodeReader<Arcane::Integer> IXMIntegerDataNodeReader;
typedef IXMDataNodeReader<Arcane::Real> IXMRealDataNodeReader;
typedef IXMDataNodeReader<Arcane::Real3> IXMReal3DataNodeReader;

/*---------------------------------------------------------------------------*/


END_ARCGEOSIM_NAMESPACE

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/


#endif /* ARCGEOSIM_ARCGEOSIM_MESH_UTILS_IXMTOOLS_IXMMESHREADERTOOLS_H */
