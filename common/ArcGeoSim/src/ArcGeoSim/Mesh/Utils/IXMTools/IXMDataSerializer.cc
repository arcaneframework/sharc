#include "IXMDataSerializer.h"
/* Author : dechaiss at Tue Oct 16 10:49:53 2012
 * Generated by createNew
 */

#include <arcane/utils/NotImplementedException.h>

#include "ArcGeoSim/Mesh/Utils/StringToItemUtils.h"
#include "ArcGeoSim/Utils/DataTypeUtils.h"

/*---------------------------------------------------------------------------*/
/* Template methods */
/*---------------------------------------------------------------------------*/

template <typename IXMDataType>
void
ArcGeoSim::IXMDataSerializer::
serializeT(const IXMDataType& ixm_data_type)
{
  ARCANE_ASSERT((ST_UnknownType == m_type),(Arcane::String::format("Cannot serialize {0} : an object is already serialized. Call deserialize first.",
                                                                   SerializedTypeTraits<IXMDataType>::name()).localstr()))
  m_buffer = new Arcane::SerializeBuffer();
  m_buffer->setMode(Arcane::ISerializer::ModeReserve);
  _reserveBufferSize(ixm_data_type);
  m_buffer->allocateBuffer();
  m_buffer->setMode(Arcane::ISerializer::ModePut);
  _serialize(ixm_data_type);
  m_type = SerializedTypeTraits<IXMDataType>::type();
}

/*---------------------------------------------------------------------------*/

template <typename IXMDataType>
void
ArcGeoSim::IXMDataSerializer::
deserializeT(IXMDataType& ixm_data_type)
{
  ARCANE_ASSERT((SerializedTypeTraits<IXMDataType>::type() == m_type),(Arcane::String::format("Cannot deserialize no {0} serialized.",
                                                                                              SerializedTypeTraits<IXMDataType>::name()).localstr()))
  m_buffer->setMode(Arcane::ISerializer::ModeGet);
  _deserialize(ixm_data_type);
  m_type = ST_UnknownType;
  delete m_buffer;
  m_buffer = NULL;
}

/*---------------------------------------------------------------------------*/

template <typename IXMDataTypeList>
void
ArcGeoSim::IXMDataSerializer::
serializeListT(const IXMDataTypeList& ixm_data_type_list)
{
  ARCANE_ASSERT((ST_UnknownType == m_type),(Arcane::String::format("Cannot serialize {0} : an object is already serialized. Call deserialize first.",
                                                                   SerializedTypeTraits<IXMDataTypeList>::name()).localstr()))
  m_buffer = new Arcane::SerializeBuffer();
  m_buffer->setMode(Arcane::ISerializer::ModeReserve);
  m_buffer->reserveInteger(1); // For list size
  typename IXMDataTypeList::const_iterator ite = ixm_data_type_list.begin();
  for (; ite != ixm_data_type_list.end(); ++ite)
    {
      _reserveBufferSize(*ite);
    }
  m_buffer->allocateBuffer();
  m_buffer->setMode(Arcane::ISerializer::ModePut);
  Arcane::Integer size = ixm_data_type_list.size();
  m_buffer->put(size);
  ite = ixm_data_type_list.begin();
  for (; ite != ixm_data_type_list.end(); ++ite)
    {
      _serialize(*ite);
    }
  m_type = SerializedTypeTraits<IXMDataTypeList>::type();
}

/*---------------------------------------------------------------------------*/

template <typename IXMDataTypeList>
void
ArcGeoSim::IXMDataSerializer::
deserializeListT(IXMDataTypeList& ixm_data_type_list)
{
  ARCANE_ASSERT((SerializedTypeTraits<IXMDataTypeList>::type() == m_type),(Arcane::String::format("Cannot deserialize no {0} serialized.",
                                                                                                  SerializedTypeTraits<IXMDataTypeList>::name()).localstr()))
  m_buffer->setMode(Arcane::ISerializer::ModeGet);
  // Deserialize erase previous data
  ixm_data_type_list.clear();
  Arcane::Integer size = m_buffer->getInteger();
  for (Arcane::Integer i = 0; i< size; ++i)
    {
      typename SerializedTypeTraits<IXMDataTypeList>::IXMDataType ixm_data_type;
      _deserialize(ixm_data_type);
      ixm_data_type_list.push_back(ixm_data_type);
    }
  m_type = ST_UnknownType;
  delete m_buffer;
  m_buffer = NULL;
}

/*---------------------------------------------------------------------------*/
/* GroupData */
/*---------------------------------------------------------------------------*/


void
ArcGeoSim::IXMDataSerializer::
serialize(const ArcGeoSim::IXMTools::IXMGroupIncrementDataList& group_increment_data_list)
{
  serializeListT(group_increment_data_list);
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
deserialize(ArcGeoSim::IXMTools::IXMGroupIncrementDataList& group_increment_data_list)
{
  deserializeListT(group_increment_data_list);
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
serialize(const ArcGeoSim::IXMTools::IXMGroupIncrementData& group_increment_data)
{
  serializeT(group_increment_data);
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
deserialize(ArcGeoSim::IXMTools::IXMGroupIncrementData& group_increment_data)
{
  deserializeT(group_increment_data);
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
serialize(const ArcGeoSim::IXMTools::IXMGroupDataList& group_data_list)
{
  serializeListT(group_data_list);
}


/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
deserialize(ArcGeoSim::IXMTools::IXMGroupDataList& group_data_list)
{
  deserializeListT(group_data_list);
}


/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
serialize(const ArcGeoSim::IXMTools::IXMGroupData& group_data)
{
  serializeT(group_data);
}


/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
deserialize(ArcGeoSim::IXMTools::IXMGroupData& group_data)
{
  deserializeT(group_data);
}

/*---------------------------------------------------------------------------*/
/* PropertyData */
/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
serialize(const ArcGeoSim::IXMTools::IXMPropertyData& property_data)
{
  serializeT(property_data);
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
deserialize(ArcGeoSim::IXMTools::IXMPropertyData& property_data)
{
  deserializeT(property_data);
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
serialize(const ArcGeoSim::IXMTools::IXMPropertyIncrementData& property_increment_data)
{
  serializeT(property_increment_data);
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
deserialize(ArcGeoSim::IXMTools::IXMPropertyIncrementData& property_increment_data)
{
  deserializeT(property_increment_data);
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
serialize(const ArcGeoSim::IXMTools::IXMPropertyDataList& property_data_list)
{
  serializeListT(property_data_list);
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
deserialize(ArcGeoSim::IXMTools::IXMPropertyDataList& property_data_list)
{
  deserializeListT(property_data_list);
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
serialize(const ArcGeoSim::IXMTools::IXMPropertyIncrementDataList& property_data_list)
{
  serializeListT(property_data_list);
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
deserialize(ArcGeoSim::IXMTools::IXMPropertyIncrementDataList& property_data_list)
{
  deserializeListT(property_data_list);
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
serialize(const ArcGeoSim::IXMTools::IXMFaceData& face_data)
{
  serializeT(face_data);
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
deserialize(ArcGeoSim::IXMTools::IXMFaceData& face_data)
{
  deserializeT(face_data);
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
broadcast()
{
  Arcane::String serialized_type_name;
  // Broadcast data
  if (m_parallel_utils.isMaster())
    {
      ARCANE_ASSERT((ST_UnknownType != m_type),("Cannot broadcast empty serializer"))
      serialized_type_name = _serializedTypeName(m_type);
    }
  else
    {
      ARCANE_ASSERT((ST_UnknownType == m_type),("A serializer is not empty on a slave process before broadcast"))
      m_buffer = new Arcane::SerializeBuffer();
    }
  m_parallel_utils.parallelMng()->broadcastSerializer(m_buffer,m_parallel_utils.masterId());
  m_parallel_utils.parallelMng()->broadcastString(serialized_type_name,m_parallel_utils.masterId());
  m_type = _serializedTypeFromName(serialized_type_name);
  if (! m_parallel_utils.isMaster()) m_buffer->setFromSizes();// TODO devrait etre inclus dans le broadcastSerlializer cf. Arc218
}

/*---------------------------------------------------------------------------*/


/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
_reserveBufferSize(const ArcGeoSim::IXMTools::IXMGroupIncrementData& group_increment_data)
{
  m_buffer->reserve(group_increment_data.mode);
  _reserveBufferSize(group_increment_data.group_data);
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
_serialize(const ArcGeoSim::IXMTools::IXMGroupIncrementData& group_increment_data)
{
  m_buffer->put(group_increment_data.mode);
  _serialize(group_increment_data.group_data);
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
_deserialize(ArcGeoSim::IXMTools::IXMGroupIncrementData& group_increment_data)
{
  m_buffer->setMode(Arcane::ISerializer::ModeGet);
  m_buffer->get(group_increment_data.mode);
  _deserialize(group_increment_data.group_data);
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
_reserveBufferSize(const ArcGeoSim::IXMTools::IXMGroupData& group_data)
{
  m_buffer->reserve(group_data.name);
  m_buffer->reserve(ArcGeoSim::StringToItemUtils::itemKindToString(group_data.kind));
  m_buffer->reserveInteger(1); // For ids array size
  m_buffer->reserve(Arcane::DT_Int64,group_data.ids.size());
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
_serialize(const ArcGeoSim::IXMTools::IXMGroupData& group_data)
{
  m_buffer->put(group_data.name);
  m_buffer->put(ArcGeoSim::StringToItemUtils::itemKindToString(group_data.kind));
  m_buffer->put(group_data.ids.size());
  m_buffer->put(group_data.ids.view());
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
_deserialize(ArcGeoSim::IXMTools::IXMGroupData& group_data)
{
  m_buffer->setMode(Arcane::ISerializer::ModeGet);
  m_buffer->get(group_data.name);
  Arcane::String kind;
  m_buffer->get(kind);
  group_data.kind = ArcGeoSim::StringToItemUtils::stringToItemKind(kind);
  group_data.ids.resize(m_buffer->getInteger());
  m_buffer->get(group_data.ids.view());
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
_reserveBufferSize(const ArcGeoSim::IXMTools::IXMPropertyData& property_data)
{
  _reserveBaseBufferSize(property_data);
  m_buffer->reserveInteger(1); // for array size
  m_buffer->reserve(Arcane::DT_Int64,property_data.support_and_values.item_ids.size());
  m_buffer->reserve(property_data.support_and_values.item_infos.data_string);
  m_buffer->reserve(ArcGeoSim::IXMTools::IXMPropertyValuesData::dataStringContentName(property_data.support_and_values.item_infos.data_string_content));
  m_buffer->reserve(Arcane::DT_Byte,1);
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
_reserveBaseBufferSize(const ArcGeoSim::IXMTools::IXMPropertyDataBase& property_data_base)
{
  m_buffer->reserve(property_data_base.kind);
  m_buffer->reserve(property_data_base.name);
  m_buffer->reserve(property_data_base.group_name);
  m_buffer->reserve(property_data_base.data_type);
  m_buffer->reserveInteger(1);
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
_serialize(const ArcGeoSim::IXMTools::IXMPropertyData& property_data)
{
  _serializeBase(property_data);
  m_buffer->put(property_data.support_and_values.item_ids.size());
  m_buffer->put(property_data.support_and_values.item_ids.view());
  m_buffer->put(property_data.support_and_values.item_infos.data_string);
  m_buffer->put(ArcGeoSim::IXMTools::IXMPropertyValuesData::dataStringContentName(property_data.support_and_values.item_infos.data_string_content));
  m_buffer->put(Arcane::Byte(property_data.support_and_values.item_infos.is_empty));
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
_serializeBase(const ArcGeoSim::IXMTools::IXMPropertyDataBase& property_data_base)
{
  m_buffer->put(property_data_base.kind);
  m_buffer->put(property_data_base.name);
  m_buffer->put(property_data_base.group_name);
  m_buffer->put(property_data_base.data_type);
  m_buffer->put(property_data_base.data_array_size);
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
_deserialize(ArcGeoSim::IXMTools::IXMPropertyData& property_data)
{
  _deserializeBase(property_data);
  property_data.support_and_values.item_ids.resize(m_buffer->getInteger());
  m_buffer->get(property_data.support_and_values.item_ids.view());
  m_buffer->get(property_data.support_and_values.item_infos.data_string);
  Arcane::String data_string_content;
  m_buffer->get(data_string_content);
  property_data.support_and_values.item_infos.data_string_content = ArcGeoSim::IXMTools::IXMPropertyValuesData::dataStringContentFromName(data_string_content);
  property_data.support_and_values.item_infos.is_empty = m_buffer->getByte();
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
_deserializeBase(ArcGeoSim::IXMTools::IXMPropertyDataBase& property_data_base)
{
  m_buffer->get(property_data_base.kind);
  m_buffer->get(property_data_base.name);
  m_buffer->get(property_data_base.group_name);
  m_buffer->get(property_data_base.data_type);
  property_data_base.data_array_size = m_buffer->getInteger();
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
_reserveBufferSize(const ArcGeoSim::IXMTools::IXMPropertyIncrementData& property_increment_data)
{
  _reserveBaseBufferSize(property_increment_data);
  m_buffer->reserveInteger(1); // for array size
  m_buffer->reserve(Arcane::DT_Int64,property_increment_data.support_and_values.item_ids.size());
  m_buffer->reserveInteger(1); // IXMPropertyIncrementValuesDataList size
  ArcGeoSim::IXMTools::IXMPropertyIncrementValuesDataList::const_iterator ite = property_increment_data.support_and_values.item_infos.begin();
  for (; ite != property_increment_data.support_and_values.item_infos.end(); ++ite)
    {
      m_buffer->reserve(ite->data_string);
      m_buffer->reserve(ArcGeoSim::IXMTools::IXMPropertyValuesData::dataStringContentName(ite->data_string_content));
      m_buffer->reserve(Arcane::DT_Byte,1); // is_empty
      m_buffer->reserve(Arcane::DT_Real,1); // time
    }
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
_serialize(const ArcGeoSim::IXMTools::IXMPropertyIncrementData& property_increment_data)
{
  _serializeBase(property_increment_data);
  m_buffer->put(property_increment_data.support_and_values.item_ids.size());
  m_buffer->put(property_increment_data.support_and_values.item_ids.view());
  m_buffer->put(Arcane::Integer(property_increment_data.support_and_values.item_infos.size()));
  ArcGeoSim::IXMTools::IXMPropertyIncrementValuesDataList::const_iterator ite = property_increment_data.support_and_values.item_infos.begin();
  for (; ite != property_increment_data.support_and_values.item_infos.end(); ++ite)
    {
      m_buffer->put(ite->data_string);
      m_buffer->put(ArcGeoSim::IXMTools::IXMPropertyValuesData::dataStringContentName(ite->data_string_content));
      m_buffer->put(Arcane::Byte(ite->is_empty)); // is_empty
      m_buffer->put(ite->time); // time
    }
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
_deserialize(ArcGeoSim::IXMTools::IXMPropertyIncrementData& property_increment_data)
{
  _deserializeBase(property_increment_data);
  property_increment_data.support_and_values.item_ids.resize(m_buffer->getInteger());
  m_buffer->get(property_increment_data.support_and_values.item_ids.view());
  Arcane::Integer values_increment_list_size = m_buffer->getInteger();
  property_increment_data.support_and_values.item_infos.clear(); // Deserialize erase old values
  for (Arcane::Integer i = 0 ; i < values_increment_list_size; ++i)
    {
      ArcGeoSim::IXMTools::IXMPropertyIncrementValuesData property_increment_values_data;
      m_buffer->get(property_increment_values_data.data_string);
      Arcane::String data_string_content;
      m_buffer->get(data_string_content);
      property_increment_values_data.data_string_content = ArcGeoSim::IXMTools::IXMPropertyValuesData::dataStringContentFromName(data_string_content);
      property_increment_values_data.is_empty = m_buffer->getByte();
      property_increment_values_data.time = m_buffer->getReal(); // time
      property_increment_data.support_and_values.item_infos.push_back(property_increment_values_data);
    }
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
_reserveBufferSize(const ArcGeoSim::IXMTools::IXMFaceData& face_data)
{
  m_buffer->reserveInteger(1); // for node_ids size
  m_buffer->reserve(Arcane::DT_Int64,face_data.node_ids.size());
  m_buffer->reserveInteger(1); // for face_ids size
  m_buffer->reserve(Arcane::DT_Int64,face_data.faces.item_ids.size());
  m_buffer->reserveInteger(1); // for face_infos size
  Arcane::eDataType data_type = ArcGeoSim::DataTypeConversion::stringToDataType("Integer");
  m_buffer->reserve(data_type,face_data.faces.item_infos.size());
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
_serialize(const ArcGeoSim::IXMTools::IXMFaceData& face_data)
{
  m_buffer->put(face_data.node_ids.size()); // for node_ids size
  m_buffer->put(face_data.node_ids.view());
  m_buffer->put(face_data.faces.item_ids.size()); // for face_ids size
  m_buffer->put(face_data.faces.item_ids.view());
  m_buffer->put(face_data.faces.item_infos.size()); // for face_infos size
  m_buffer->put(face_data.faces.item_infos.view()); // for face_infos size
}

/*---------------------------------------------------------------------------*/

void
ArcGeoSim::IXMDataSerializer::
_deserialize(ArcGeoSim::IXMTools::IXMFaceData& face_data)
{
  face_data.node_ids.resize(m_buffer->getInteger()); // for node_ids size
  m_buffer->get(face_data.node_ids.view());
  face_data.faces.item_ids.resize(m_buffer->getInteger()); // for face_ids size
  m_buffer->get(face_data.faces.item_ids.view());
  face_data.faces.item_infos.resize(m_buffer->getInteger()); // for face_infos size
  m_buffer->get(face_data.faces.item_infos.view()); // for face_infos size
}

/*---------------------------------------------------------------------------*/

Arcane::String
ArcGeoSim::IXMDataSerializer::
_serializedTypeName(const ArcGeoSim::IXMDataSerializer::SerializedType serialized_type)
{
  Arcane::String serialized_type_name;
  switch (serialized_type) {
    case ST_IXMGroupDataList:
      {
        serialized_type_name = "ST_IXMGroupDataList";
        break;
      }
    case ST_IXMGroupData:
      {
        serialized_type_name = "ST_IXMGroupData";
        break;
      }
    case ST_IXMGroupIncrementDataList:
      {
        serialized_type_name = "ST_IXMGroupIncrementDataList";
        break;
      }
    case ST_IXMGroupIncrementData:
      {
        serialized_type_name = "ST_IXMGroupIncrementData";
        break;
      }
    case ST_IXMPropertyData :
      {
        serialized_type_name = "ST_IXMPropertyData";
        break;
      }
    case ST_IXMPropertyDataList :
      {
        serialized_type_name = "ST_IXMPropertyDataList";
        break;
      }
    case ST_IXMPropertyIncrementData :
      {
        serialized_type_name = "ST_IXMPropertyIncrementData";
        break;
      }
    case ST_IXMPropertyIncrementDataList :
      {
        serialized_type_name = "ST_IXMPropertyIncrementDataList";
        break;
      }
    case ST_IXMFaceData :
      {
        serialized_type_name = "ST_IXMFaceData";
        break;
      }
    case ST_UnknownType:
      {
        serialized_type_name = "ST_UnknownType";
        break;
      }
  }
  return serialized_type_name;
}


/*---------------------------------------------------------------------------*/

ArcGeoSim::IXMDataSerializer::SerializedType
ArcGeoSim::IXMDataSerializer::
_serializedTypeFromName(const Arcane::String& serialized_type_name)
{
  if (serialized_type_name == "ST_IXMGroupDataList") return ST_IXMGroupDataList;
  if (serialized_type_name == "ST_IXMGroupData") return ST_IXMGroupData;
  if (serialized_type_name == "ST_IXMGroupIncrementDataList") return ST_IXMGroupIncrementDataList;
  if (serialized_type_name == "ST_IXMGroupIncrementData") return ST_IXMGroupIncrementData;
  if (serialized_type_name == "ST_IXMPropertyData") return ST_IXMPropertyData;
  if (serialized_type_name == "ST_IXMPropertyDataList") return ST_IXMPropertyDataList;
  if (serialized_type_name == "ST_IXMPropertyIncrementData") return ST_IXMPropertyIncrementData;
  if (serialized_type_name == "ST_IXMPropertyIncrementDataList") return ST_IXMPropertyIncrementDataList;
  if (serialized_type_name == "ST_IXMFaceData") return ST_IXMFaceData;
  if (serialized_type_name == "ST_UnknownType") return ST_UnknownType;
  throw Arcane::NotImplementedException(A_FUNCINFO, "Unexpected serialized type");
}

/*---------------------------------------------------------------------------*/

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/
