#ifndef ARCGEOSIM_MESH_GENERATOR_MULTIBLOCKMESHGENERATOR_MULTIBLOCKMESHGENERATORSERVICE_H
#define ARCGEOSIM_MESH_GENERATOR_MULTIBLOCKMESHGENERATOR_MULTIBLOCKMESHGENERATORSERVICE_H
/* Author : gratienj at Thu Mar 19 08:52:11 2009
 * Generated by createNew
 */

// Interface du service 
#include "ArcGeoSim/Mesh/Generator/IMeshGenerator.h"

namespace Arcane { }
using namespace Arcane;

class IFunctionR2vR1 ;

#include "MultiBlockMeshGenerator_axl.h"

class MultiBlockMeshGeneratorService :
  public ArcaneMultiBlockMeshGeneratorObject
{
public:
  /** Constructeur de la classe */
  MultiBlockMeshGeneratorService(const Arcane::ServiceBuildInfo & sbi) : 
    ArcaneMultiBlockMeshGeneratorObject(sbi) 
    {
      ;
    }
  
  /** Destructeur de la classe */
  virtual ~MultiBlockMeshGeneratorService() {}
  
public:

  //! Initialisation
  void init();

  //! Apply service function
  void generate();
  
  class Block
  {
  public :
    Block(Integer nx,Integer ny,Integer nz,
          Real dx, Real dy, Real dz)
    : m_nx(nx)
    , m_ny(ny)
    , m_nz(nz)
    , m_dx(dx)
    , m_dy(dy)
    , m_dz(dz)
    , m_func(NULL)
    {
      m_Lx = m_nx-1 ;
      m_Ly = m_ny-1 ;
      m_Lz = m_nz-1 ;
      m_Sxy = m_Lx*m_Ly ;
      m_Syz = m_Ly*m_Lz ;
      m_Sxz = m_Lx*m_Lz ;
      m_nodes_num = m_nx*m_ny*m_nz ;
      m_cells_num = m_Lx*m_Ly*m_Lz ;
      m_faces_num = 3*m_cells_num+m_Sxy+m_Syz+m_Sxz ;
    }
    
    Integer getNx() const { return m_nx ; }
    Integer getNy() const { return m_ny ; }
    Integer getNz() const { return m_nz ; }
    Integer getLx() const { return m_Lx ; }
    Integer getLy() const { return m_Ly ; }
    Integer getLz() const { return m_Lz ; }
    Integer getSxy() const { return m_Sxy ; }
    Integer getSyz() const { return m_Syz ; }
    Integer getSxz() const { return m_Sxz ; }
    
    Integer getNumOfNodes() const { return m_nodes_num ; }
    Integer getNodesIdOffset() const { return m_nodes_id_offset ; }
    Integer getNodeId(Integer i, Integer j, Integer k)
    {
      return m_nodes_id_offset + k*m_nx*m_ny + j*m_nx + i ;
    }
    void setNodesIdOffset(Integer offset) { m_nodes_id_offset = offset ; }
    Integer getNumOfCells() const { return m_cells_num ; }
    Integer getCellsIdOffset() const { return m_cells_id_offset ; }
    void setCellsIdOffset(Integer offset) { m_cells_id_offset = offset ; }
    Integer getLocalCellId(Integer i, Integer j, Integer k)
    {
      return k*m_Sxy + j*m_Lx + i ;
    }
    Integer getCellId(Integer i, Integer j, Integer k)
    {
      return m_cells_id_offset + getLocalCellId(i,j,k) ;
    }
    
    Integer getNumOfFaces() const { return m_faces_num ; }
    Integer getFacesIdOffset() const { return m_faces_id_offset ; }
    void setFacesIdOffset(Integer offset) { m_faces_id_offset = offset ; }
    Integer getLocalFaceId(Integer i, Integer j, Integer k, Integer l)
    {
      if(l<3)
      {
        return 3*getLocalCellId(i,j,k) + l ;
      }
      else
      {
        switch(l)
        {
        case 3 :
          //Z sup
          if(k!=m_ny-2)
          {
            cerr<<"Bad face id ("<<i<<","<<j<<","<<k<<","<<l<<")";
            Arcane::FatalErrorException(A_FUNCINFO,"Bad face id");
          }
          return 3*m_cells_num+j*m_Lx+i ;
        case 4 :
          //X sup
          if(i!=m_nx-2)
          {
            cerr<<"Bad face id ("<<i<<","<<j<<","<<k<<","<<l<<")";
            Arcane::FatalErrorException(A_FUNCINFO,"Bad face id");
          }
          return 3*m_cells_num+m_Sxy+k*m_Ly+j ;
        case 5 :
          //Y sup
          if(j!=m_ny-2)
          {
            cerr<<"Bad face id ("<<i<<","<<j<<","<<k<<","<<l<<")";
            Arcane::FatalErrorException(A_FUNCINFO,"Bad face id");
          }
          return 3*m_cells_num+m_Sxy+m_Syz+k*m_Lx+i ;
        default :
          throw Arcane::FatalErrorException(A_FUNCINFO,"Bad face id");
          return -1 ;
        }
        
      }
    }
    Integer getFaceId(Integer i, Integer j, Integer k, Integer l)
    {
      return m_faces_id_offset + getLocalFaceId(i,j,k,l) ;
    }
    Real3 getNodeCoord(Integer i, Integer j, Integer k)
    {
      Real x = m_O.x + i*m_dx ;
      Real y = m_O.y + j*m_dy ;
      Real z = k*m_dz ;
      if(m_func)
        z += m_func->eval(x,y) ;
      return Real3(x,y,z) ;
    }
    Real3 getCellCenter(Integer i, Integer j, Integer k)
    {
      Real3 center = getNodeCoord(i,j,k) ;
      Real3 d(m_dx/2,m_dy/2,m_dz/2) ;
      return center + d ;
    }
    Real getCellVolume(Integer i, Integer j, Integer k)
    {
      return m_dx*m_dy*m_dz ;
    }
    Real3 getFaceCenter(Integer i, Integer j, Integer k,Integer l)
    {
      Real3 center = getNodeCoord(i,j,k) ;
      switch(l)
      {
      case 0 :
        return center + Real3(m_dx/2,m_dy/2,0) ;
      case 1 :
        return center + Real3(0,m_dz/2,m_dz/2) ;
      case 2 :
        return center + Real3(m_dx/2,0,m_dz/2) ;
      case 3 :
        return center + Real3(m_dx/2,m_dy/2,m_dz) ;
      case 4 :
        return center + Real3(m_dx,m_dy/2,m_dz/2) ;
      case 5 :
        return center + Real3(m_dx/2,m_dy,m_dz/2) ;
      default :
        return center ;
      }
    }
    Real3 getFaceNormal(Integer i, Integer j, Integer k,Integer l)
    {
      switch(l)
      {
      case 0 :
        return Real3(0,0,m_dx*m_dy) ;
      case 1 :
        return Real3(m_dy*m_dz,0,0) ;
      case 2 :
        return Real3(0,m_dx*m_dz,0) ;
      case 3 :
        return Real3(0,0,-m_dx*m_dy) ;
      case 4 :
        return Real3(-m_dz*m_dy,0,0) ;
      case 5 :
        return Real3(0,-m_dx*m_dz,0) ;
      default :
        throw Arcane::FatalErrorException(A_FUNCINFO,"problem with face id");
      }
    }
    Real getFaceSurface(Integer i, Integer j, Integer k,Integer l)
    {
      switch(l)
      {
      case 0 :
        return m_dx*m_dy ;
      case 1 :
        return m_dy*m_dz ;
      case 2 :
        return m_dx*m_dz ;
      case 3 :
        return m_dx*m_dy ;
      case 4 :
        return m_dz*m_dy ;
      case 5 :
        return m_dx*m_dz ;
      default :
        throw Arcane::FatalErrorException(A_FUNCINFO,"problem with face id");
      }
    }
    
    Integer getFaceDirLabel(Integer l)
    {
      switch(l)
      {
      case 0 :
        return 2 ;
      case 1 :
        return 0 ;
      case 2 :
        return 1 ;
      case 3 :
        return 2 ;
      case 4 :
        return 0 ;
      case 5 :
        return 1 ;
      default :
        throw Arcane::FatalErrorException(A_FUNCINFO,"problem with face id");
      }
    }
    
    void setOrigin(Real3 origin)
    {
      m_O = origin ;
    }
    
    void setFunc(IFunctionR2vR1* func)
    {
      m_func = func ;
    }
  private :
    Integer m_nx ;
    Integer m_ny ;
    Integer m_nz ;
    Integer m_Lx ;
    Integer m_Ly ;
    Integer m_Lz ;
    Integer m_Sxy ;
    Integer m_Syz ;
    Integer m_Sxz ;
    Integer m_nodes_num ;
    Integer m_nodes_id_offset ;
    Integer m_cells_num ;
    Integer m_cells_id_offset ;
    Integer m_faces_num ;
    Integer m_faces_id_offset ;
    Real3 m_O ;
    Real m_dx ;
    Real m_dy ;
    Real m_dz ;
    IFunctionR2vR1* m_func ;
  };
  
private :
  Integer m_blocks_num ;
  SharedArray<Block*> m_blocks ;
  IFunctionR2vR1* m_func ;
};

#endif /* ARCGEOSIM_MESH_GENERATOR_MULTIBLOCKMESHGENERATOR_MULTIBLOCKMESHGENERATORSERVICE_H */
