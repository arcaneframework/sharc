
#include "ArcGeoSim/Utils/Utils.h"
#include "ArcGeoSim/Numerics/Expressions/IFunctionR2vR1.h"
#include "MultiBlockMeshGeneratorService.h"
/* Author : gratienj at Thu Mar 19 08:52:11 2009
 * Generated by createNew
 */

using namespace Arcane;

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

void 
MultiBlockMeshGeneratorService::
init()
{
  m_func = options()->bottomHeight() ;
  m_func->init() ;
  m_blocks_num = options()->block.size();
  if(m_blocks_num==0)
    fatal()<<"Generator needs at least one defined block" ;
  m_blocks.resize(m_blocks_num) ;
  Real3 origin(0.,0.,m_func->eval(0.,0.)) ;
  for(Integer i=0;i<m_blocks_num;++i)
  {
    Integer nx = options()->block[i]->Nx() ;
    Integer ny = options()->block[i]->Ny() ;
    Integer nz = options()->block[i]->Nz() ;
    Real dx = options()->block[i]->Dx() ;
    Real dy = options()->block[i]->Dy() ;
    Real dz = options()->block[i]->Dz() ;
    m_blocks[i] = new Block(nx,ny,nz,dx,dy,dz) ;
    m_blocks[i]->setFunc(m_func) ;
    m_blocks[i]->setOrigin(origin) ;
    origin = m_blocks[i]->getNodeCoord(nx-1,0,0) ;
  }
}

/*---------------------------------------------------------------------------*/

void 
MultiBlockMeshGeneratorService::
generate()
{
  Integer nb_nodes = 0 ;
  Integer nb_cells = 0 ;
  Integer nb_faces = 0 ;
  for(Integer iblock=0;iblock<m_blocks_num;++iblock)
  {
    nb_nodes += m_blocks[iblock]->getNumOfNodes() ;
    nb_cells += m_blocks[iblock]->getNumOfCells() ;
    nb_faces += m_blocks[iblock]->getNumOfFaces() ;
  }
  String file_name = options()->file() ;
  ofstream file(file_name.localstr()) ;
  file<<"// number of nodes"<<endl;
  file<<nb_nodes<<endl;
  file<<"// node identifiers"<<endl;
  Integer node_id = 0 ;
  for(Integer iblock=0;iblock<m_blocks_num;++iblock)
  {
    m_blocks[iblock]->setNodesIdOffset(node_id) ;
    for(Integer i=0;i<m_blocks[iblock]->getNumOfNodes();++i)
    {
      file<<node_id<<endl;
      ++node_id ;
    }
  }
  file<<"// number of cells"<<endl;
  file<<nb_cells<<endl;
  Integer cell_id = 0 ;
  for(Integer iblock=0;iblock<m_blocks_num;++iblock)
  {
    Block* block = m_blocks[iblock] ;
    block->setCellsIdOffset(cell_id) ;
    for(Integer k=0;k<block->getNz()-1;++k)
      for(Integer j=0;j<block->getNy()-1;++j)
        for(Integer i=0;i<block->getNx()-1;++i)
        {
          file<<"IT_Hexaedron8"<<endl;
          file<<cell_id<<endl;
          file<<8<<endl;
          file<<block->getNodeId(i,j,k)<<" ";
          file<<block->getNodeId(i+1,j,k)<<" ";
          file<<block->getNodeId(i+1,j+1,k)<<" ";
          file<<block->getNodeId(i,j+1,k)<<" ";
          file<<block->getNodeId(i,j,k+1)<<" ";
          file<<block->getNodeId(i+1,j,k+1)<<" ";
          file<<block->getNodeId(i+1,j+1,k+1)<<" ";
          file<<block->getNodeId(i,j+1,k+1)<<endl;
          ++cell_id ;
        }
  }

  {
    file<<"// number of faces"<<endl;
    file<<nb_faces<<endl;
    Integer face_id = 0 ;
    for(Integer iblock=0;iblock<m_blocks_num;++iblock)
    {
      Block* block = m_blocks[iblock] ;
      block->setFacesIdOffset(face_id) ;
      for(Integer k=0;k<block->getNz()-1;++k)
        for(Integer j=0;j<block->getNy()-1;++j)
          for(Integer i=0;i<block->getNx()-1;++i)
          {
            for(Integer l=0;l<3;++l)
            {
              file<<face_id<<endl;
              file<<block->getCellId(i,j,k)<<endl;
              file<<l<<endl ;
              ++face_id ;
            }
          }
      {
        /* Z sup*/
        Integer k = block->getNz() - 2 ;
        for(Integer j=0;j<block->getNy()-1;j++)
          for(Integer i=0;i<block->getNx()-1;i++)
          {
            Integer cell_id    = block->getCellId(i,j,k) ;
            file<<face_id<<endl;
            file<<cell_id<<endl;
            file<<3<<endl ;
            ++face_id ;
          }
      }
      {
        /* X sup*/
        Integer i = block->getNx() - 2; 
        for(Integer k=0;k<block->getNz()-1;k++)
          for(Integer j=0;j<block->getNy()-1;j++)
          {
            Integer cell_id    = block->getCellId(i,j,k) ;
            file<<face_id<<endl;
            file<<cell_id<<endl;
            file<<4<<endl ;
            ++face_id ;
          }
      }
      {
        /* Y sup*/
        Integer j=block->getNy()-2; 
        for(Integer k=0;k<block->getNz()-1;k++)
          for(Integer i=0;i<block->getNx()-1;i++)
          {
            Integer cell_id    = block->getCellId(i,j,k) ;
            file<<face_id<<endl;
            file<<cell_id<<endl;
            file<<5<<endl ;
            ++face_id ;
          }
      }
    }
  }
  {
    file<<"// non coincidence info"<<endl;
    file<<0<<endl;
    file<<"// update node info"<<endl;
    file<<0<<endl;
  }
  {
    file<<"// coordonnée des nodes"<<endl;
    for(Integer iblock=0;iblock<m_blocks_num;++iblock)
    {
      Block* block = m_blocks[iblock] ;
      for(Integer k=0;k<block->getNz();++k)
        for(Integer j=0;j<block->getNy();++j)
          for(Integer i=0;i<block->getNx();++i)
          {
            Real3 coord = block->getNodeCoord(i,j,k) ;
            file<<coord.x<<" "<<coord.y<<" "<<coord.z<<endl;
          }
    }
  }
  {
    file<<"// coordonnée des mailles"<<endl;
    for(Integer iblock=0;iblock<m_blocks_num;++iblock)
    {
      Block* block = m_blocks[iblock] ;
      for(Integer k=0;k<block->getNz()-1;++k)
        for(Integer j=0;j<block->getNy()-1;++j)
          for(Integer i=0;i<block->getNx()-1;++i)
          {
            Real3 coord = block->getCellCenter(i,j,k) ;
            file<<coord.x<<" "<<coord.y<<" "<<coord.z<<endl;
            file<<block->getCellVolume(i,j,k)<<endl ;
          }
    }
  }
  {
    file<<"// face geometry "<<endl;
    for(Integer iblock=0;iblock<m_blocks_num;++iblock)
    {
      Block* block = m_blocks[iblock] ;
      for(Integer i=0;i<block->getNx()-1;++i)
        for(Integer j=0;j<block->getNy()-1;++j)
          for(Integer k=0;k<block->getNz()-1;++k)
          {
            for(Integer l=0;l<3;++l)
            {
              Real3 center = block->getFaceCenter(i,j,k,l) ;
              Real3 normal = block->getFaceNormal(i,j,k,l) ;
              file<<block->getFaceSurface(i,j,k,l)<<endl;
              file<<center.x<<" "<<center.y<<" "<<center.z<<endl;
              file<<normal.x<<" "<<normal.y<<" "<<normal.z<<endl;
            }
          }
      {
        /* Z sup*/
        Integer k = block->getNz() - 2 ;
        Integer l = 3 ;
        for(Integer j=0;j<block->getNy()-1;j++)
          for(Integer i=0;i<block->getNx()-1;i++)
          {
            Real3 center = block->getFaceCenter(i,j,k,l) ;
            Real3 normal = block->getFaceNormal(i,j,k,l) ;
            file<<block->getFaceSurface(i,j,k,l)<<endl;
            file<<center.x<<" "<<center.y<<" "<<center.z<<endl;
            file<<normal.x<<" "<<normal.y<<" "<<normal.z<<endl;
          }
      }
      {
        /* X sup*/
        Integer i = block->getNx() - 2; 
        Integer l = 4 ;
        for(Integer k=0;k<block->getNz()-1;k++)
          for(Integer j=0;j<block->getNy()-1;j++)
          {
            Real3 center = block->getFaceCenter(i,j,k,l) ;
            Real3 normal = block->getFaceNormal(i,j,k,l) ;
            file<<block->getFaceSurface(i,j,k,l)<<endl;
            file<<center.x<<" "<<center.y<<" "<<center.z<<endl;
            file<<normal.x<<" "<<normal.y<<" "<<normal.z<<endl;
          }
      }
      {
        /* Y sup*/
        Integer j=block->getNy()-2; 
        Integer l = 5 ;
        for(Integer k=0;k<block->getNz()-1;k++)
          for(Integer i=0;i<block->getNx()-1;i++)
          {
            Real3 center = block->getFaceCenter(i,j,k,l) ;
            Real3 normal = block->getFaceNormal(i,j,k,l) ;
            file<<block->getFaceSurface(i,j,k,l)<<endl;
            file<<center.x<<" "<<center.y<<" "<<center.z<<endl;
            file<<normal.x<<" "<<normal.y<<" "<<normal.z<<endl;
          }
      }
    }
  }
  {
    file<<"// non coincidence geometry"<<endl;
    file<<"SYM"<<endl;
  }
  {
    file<<" properties"<<endl;
    file<<"// direction des faces. 0 = i constant, 1 = j constant, 2 = k constant"<<endl;
    file<<"FACE"<<endl;
    file<<"LABEL"<<endl;
    file<<1<<endl;
    file<<nb_faces<<endl;
    for(Integer iblock=0;iblock<m_blocks_num;++iblock)
    {
      Block* block = m_blocks[iblock] ;
      for(Integer i=0;i<block->getNx()-1;++i)
        for(Integer j=0;j<block->getNy()-1;++j)
          for(Integer k=0;k<block->getNz()-1;++k)
          {
            for(Integer l=0;l<3;++l)
            {
              file<<block->getFaceId(i,j,k,l)<<" "<<block->getFaceDirLabel(l)<<endl ;
            }
          }
      {
        /* Z sup*/
        Integer k = block->getNz() - 2 ;
        Integer l = 3 ;
        for(Integer j=0;j<block->getNy()-1;j++)
          for(Integer i=0;i<block->getNx()-1;i++)
          {
            file<< block->getFaceId(i,j,k,l)<<" "<<block->getFaceDirLabel(l)<<endl ;
          }
      }
      {
        /* X sup*/
        Integer i = block->getNx() - 2; 
        Integer l = 4 ;
        for(Integer k=0;k<block->getNz()-1;k++)
          for(Integer j=0;j<block->getNy()-1;j++)
          {
            file<< block->getFaceId(i,j,k,l)<<" "<<block->getFaceDirLabel(l)<<endl ;
          }
      }
      {
        /* Y sup*/
        Integer j=block->getNy()-2; 
        Integer l = 5 ;
        for(Integer k=0;k<block->getNz()-1;k++)
          for(Integer i=0;i<block->getNx()-1;i++)
          {
            file<< block->getFaceId(i,j,k,l)<<" "<<block->getFaceDirLabel(l)<<endl ;
          }
      }
    }
  }
  {
    for(Integer iblock=0;iblock<m_blocks_num;++iblock)
    {
      Block* block = m_blocks[iblock] ;
      {
        file<<"FACE"<<endl;
        file<<"GROUP_XMinBlock"<<iblock<<endl;
        file<<1<<endl;
        file<<block->getSyz()<<endl ;
        Integer i = 0; 
        Integer l = 1 ;
        for(Integer k=0;k<block->getNz()-1;k++)
          for(Integer j=0;j<block->getNy()-1;j++)
          {
            file<< block->getFaceId(i,j,k,l)<<endl;
          }
      }
      {
        file<<"FACE"<<endl;
        file<<"GROUP_XMaxBlock"<<iblock<<endl;
        file<<1<<endl;
        file<<block->getSyz()<<endl ;
        Integer i = block->getNx()-2; 
        Integer l = 4 ;
        for(Integer k=0;k<block->getNz()-1;k++)
          for(Integer j=0;j<block->getNy()-1;j++)
          {
            file<< block->getFaceId(i,j,k,l) <<endl;
          }
      }
      {
        file<<"FACE"<<endl;
        file<<"GROUP_YMinBlock"<<iblock<<endl;
        file<<1<<endl;
        file<<block->getSxz()<<endl ;
        Integer j = 0; 
        Integer l = 2 ;
        for(Integer k=0;k<block->getNz()-1;k++)
          for(Integer i=0;i<block->getNx()-1;i++)
          {
            file<< block->getFaceId(i,j,k,l)<<endl ;
          }
      }
      {
        file<<"FACE"<<endl;
        file<<"GROUP_YMaxBlock"<<iblock<<endl;
        file<<1<<endl;
        file<<block->getSxz()<<endl ;
        Integer j = block->getNy()-2; 
        Integer l = 5 ;
        for(Integer k=0;k<block->getNz()-1;k++)
          for(Integer i=0;i<block->getNx()-1;i++)
          {
            file<< block->getFaceId(i,j,k,l)<<endl ;
          }
      }
      {
        file<<"FACE"<<endl;
        file<<"GROUP_ZMinBlock"<<iblock<<endl;
        file<<1<<endl;
        file<<block->getSxy()<<endl ;
        Integer k = 0; 
        Integer l = 0 ;
        for(Integer j=0;j<block->getNy()-1;j++)
          for(Integer i=0;i<block->getNx()-1;i++)
          {
            file<< block->getFaceId(i,j,k,l)<<endl ;
          }
      }
      {
        file<<"FACE"<<endl;
        file<<"GROUP_XMaxBlock"<<iblock<<endl;
        file<<1<<endl;
        file<<block->getSxy()<<endl ;
        Integer k = block->getNz()-2; 
        Integer l = 3 ;
        for(Integer j=0;j<block->getNy()-1;j++)
          for(Integer i=0;i<block->getNx()-1;i++)
          {
            file<< block->getFaceId(i,j,k,l)<<endl ;
          }
      }
    }
  }
  {
    for(Integer iblock=0;iblock<m_blocks_num;++iblock)
    {
      Block* block = m_blocks[iblock] ;
      for(Integer k=0;k<block->getNz()-1;k++)
      {
        file<<"MAILLE"<<endl;
        file<<"GROUP_Layer"<<k<<"Block"<<iblock<<endl;
        file<<1<<endl;
        file<<block->getSxy()<<endl ;
        for(Integer j=0;j<block->getNy()-1;j++)
          for(Integer i=0;i<block->getNx()-1;i++)
          {
            file<< block->getCellId(i,j,k)<<endl;
          }
      }
    }
  }
}

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

ARCANE_REGISTER_SERVICE_MULTIBLOCKMESHGENERATOR(MultiBlockMeshGenerator,MultiBlockMeshGeneratorService);
