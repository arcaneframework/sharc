#ifndef ARCGEOSIM_NUMERICS_NONLINEARSOLVER_NONLINEARSYSTEMT_H
#define ARCGEOSIM_NUMERICS_NONLINEARSOLVER_NONLINEARSYSTEMT_H
/* Author : desrozis at Fri Mar 27 12:11:29 2009
 * Generated by createNew
 */

#include "ArcGeoSim/Utils/VisitorT.h"
#include "ArcGeoSim/Numerics/LinearSolver/LocalDirectSolverImpl/ILinearSystemBuilder.h"

#ifdef USE_ALIEN_V1
#include <ALIEN/Alien-IFPEN.h>
#endif

using namespace Arcane;

class INonLinearSystemVisitor;
class INonLinearSystem ;


#ifdef USE_ALIEN_V1
template<typename ModelType, typename MatrixT = Alien::Matrix, typename VectorT = Alien::Vector>
#endif
#ifdef USE_ALIEN_V2
template<typename ModelType, typename MatrixT = Alien::Matrix, typename VectorT = Alien::Vector>
#endif
#ifdef USE_ALIEN_V0
  template<typename ModelType>
#endif
#ifdef USE_ALIEN_ARCGEOSIM
  template<typename ModelType>
#endif
  class NonLinearSystemT : public INonLinearSystem
  {
  public:
  typedef NonLinearSystemT<ModelType> ThisType ;
  typedef VisitorT<ThisType> VisitorThisType ;
#ifdef USE_ALIEN_V0
  typedef MatrixType ThisMatrixType;
  typedef VectorType ThisVectorType;
#endif
#ifdef USE_ALIEN_V1
  typedef MatrixT ThisMatrixType;
  typedef VectorT ThisVectorType;
#endif
#ifdef USE_ALIEN_V2
  typedef MatrixT ThisMatrixType;
  typedef VectorT ThisVectorType;
#endif
#ifdef USE_ALIEN_ARCGEOSIM
  typedef MatrixType ThisMatrixType;
  typedef VectorType ThisVectorType;
#endif
  /** Constructeur de la classe */
  NonLinearSystemT(ModelType* model)
  : m_model(model)
  , m_builder(NULL)
  {}
  
  /** Destructeur de la classe */
  virtual ~NonLinearSystemT() { }
  
  public:

  //! Initialisation
  void init() {
    m_builder = m_model->getLinearSystemBuilder() ;
    if(m_builder)
      m_builder->init() ;
  }
  
  //! Initializing the system 
  void start() {
    if(m_builder)
      m_builder->start() ;
  }
  
  //! Finalizing the system
  void end() {
    if(m_builder)
      m_builder->end() ;
  }
  
  void allocateData() {}
  void freeData() {}


  virtual void initLinearSystem() {
  }

  //A. Anciaux pour BlockTailleVariable
  virtual void initLinearSystem(bool rs_block) {
  }
  

  virtual void buildLinearSystem() {
  }


  Integer updateLinearSolution() {
    //return m_model->commitLinearSolution() ;
    return 0 ;
  }

  //! Computing at the begin of the iterative step 
  void startStep() {
    m_model->startNewtonStep() ;
  }
  
  //! Computing at the end of the iterative step
  void endStep() {
    m_model->endNewtonStep() ;
  }
  
  INonLinearSystem* asINonLinearSystem() {
    return this ;
  }
  //! Visitor pattern
  Integer accept(INonLinearSystemVisitor* visitor) {
    VisitorThisType* ptr = dynamic_cast<VisitorThisType*> (visitor) ;
    if(ptr)
      return ptr->visit(this) ;
    else
      return visitor->visit(asINonLinearSystem()) ;
  }

  ThisMatrixType const& getMatrix() const {
    return m_matrix ;
  }

  ThisMatrixType& getMatrix() {
    return m_matrix ;
  }

  ThisVectorType const& getRHS() const {
    return m_rhs ;
  }

  ThisVectorType& getRHS() {
    return m_rhs ;
  }

  ThisVectorType const& getSolution() const{
    return m_sol ;
  }

  ThisVectorType&       getSolution() {
    return m_sol ;
  }
  
  Integer buildLinearizedSystem() {
    return m_model->buildLinearizedSystem() ;
  }
  
  Integer updateVariable() {
    return m_model->updateVariable() ;
  }
  
  template<typename NormeType>
  Real getNewtonResidual(NormeType& norme)
  {
    return m_model->getNewtonResidual(norme) ;
  }
  
  Integer getNumericalError() {
    return m_model->getNumericalError() ;
  }
  
  private :
  ModelType* m_model ;
  ILinearSystemBuilder* m_builder ;
  protected :
  ThisMatrixType                m_matrix;
  ThisVectorType                m_rhs ;
  ThisVectorType                m_sol ;
  };

#endif /* ARCGEOSIM_NUMERICS_NONLINEARSOLVER_NONLINEARSYSTEMT_H */
