#ifndef ARCGEOSIM_NUMERICS_NONLINEARSOLVER_NEWTONIMPL_NEWTONSOLVERSERVICE_H
#define ARCGEOSIM_NUMERICS_NONLINEARSOLVER_NEWTONIMPL_NEWTONSOLVERSERVICE_H
/* Author : desrozis at Tue Mar 31 14:41:47 2009
 * Generated by createNew
 */

#include "ArcGeoSim/Numerics/NonLinearSolver/INonLinearModel.h"
#include "ArcGeoSim/Numerics/NonLinearSolver/INonLinearSolver.h"
#include "ArcGeoSim/Numerics/NonLinearSolver/INonLinearSystem.h"
#include "ArcGeoSim/Numerics/NonLinearSolver/INonLinearSystemBuilder.h"
#include "ArcGeoSim/Numerics/NonLinearSolver/INonLinearStopCriteria.h"
#include "ArcGeoSim/Numerics/LinearSolver/LocalDirectSolverImpl/ILinearSolver.h"

#include "ArcGeoSim/Appli/IInfoModel.h"

namespace Arcane { }
using namespace Arcane;

#include "NewtonSolver_axl.h"

#include <arcane/Timer.h>
#include <arcane/utils/String.h>

#ifdef USE_ALIEN_ARCGEOSIM
namespace LocalDirectSolverNamespace {
  class ILinearSolver;
};
#endif
#ifdef USE_ALIEN_V0
namespace LocalDirectSolverNamespace {
  class ILinearSolver;
};
#endif
#ifdef USE_ALIEN_V1
namespace Alien
{
  class ILinearSolver;
};
#endif
#ifdef USE_ALIEN_V2
namespace Alien
{
  class ILinearSolver;
};
#endif

class INonLinearStopCriteria;

class NewtonSolverService :
public ArcaneNewtonSolverObject,
  public IInfoModel
{
 public:
  /** Constructeur de la classe */
 NewtonSolverService(const Arcane::ServiceBuildInfo & sbi)
   : ArcaneNewtonSolverObject(sbi)
    , m_solver_timer(sbi.subDomain(),"NewtonSolverTimer",Timer::TimerReal)
    , m_solver_cpu_timer(sbi.subDomain(),"NewtonSolverCPUTimer",Timer::TimerVirtual)
    , m_build_timer(sbi.subDomain(),"NewtonSystemTimer",Timer::TimerReal)
    , m_build_cpu_timer(sbi.subDomain(),"NewtonSystemCPUTimer",Timer::TimerVirtual)
    , m_status(NotConverged)
    {
      ;
    }

  /** Destructeur de la classe */
  virtual ~NewtonSolverService();

 public:

  //! Initialisation
  void init();

  //! Setting non linear sytem builder
  void setNonLinearSystemBuilder(INonLinearSystemBuilder * builder);

  //! Setting variable updater
  void setVariableUpdater(INonLinearSystemVisitor * updater);

  //! Setting linear solver
  void setLinearSolver(LocalDirectSolverNamespace::ILinearSolver * solver);

  void setLinearSolver(Alien::ILinearSolver * solver) ;

  //! Setting linear system builder
  void setLinearSystemBuilder(ILinearSystemBuilder * builder);

  //! Setting stop criteria
  void setStopCriteria(INonLinearStopCriteria * stop_criteria);

  //! Initializing (before solve)
  void start(INonLinearSystem * system);

  //! Solving non linear problem
  bool solve(INonLinearSystem * system);
  
  bool solveOpt(INonLinearSystem * system);

  //! Finalizing (after solve)
  void end(INonLinearSystem * system);

  const Status & getStatus() const {
    return m_solver_status ;
  }

  //! Info
  void printInfo();
  void printCurrentTimeInfo() {}

 private :
  inline void _start(INonLinearSystem* system)
  {
    m_solver_status.error = 0 ;
    m_solver_status.succeeded = false ;
    m_solver_status.iteration_count = 0 ;
    m_non_linear_system_builder->start(system);
  }

  inline void _end(INonLinearSystem * system)
  {
    m_solver_status.iteration_count = m_iteration ;
    m_solver_status.error = m_status ;
    m_solver_status.residual = m_stop_criteria->criteriaValue() ;
    m_solver_status.succeeded = (m_status == Converged) ;
  }

  //! Build non linear system (Flux and residual)
  Integer _buildNonLinearSystem(INonLinearSystem * system);

  //! new algorithm version with LinearAlgebra2 package
  bool _solve(INonLinearSystem * system, Alien::ILinearSolver* solver) ;

  //! old algorithm version with LinearSolver package
  bool _solve(INonLinearSystem * system,LocalDirectSolverNamespace::ILinearSolver* solver) ;

  //! Check the stop criteria
  UInt32 _stop(INonLinearSystem * system, Real& criteria);

  inline UInt32 _stop(INonLinearSystem * system)
  {
    return system->accept(m_stop_criteria) ;
  }

  //! Update variable
  inline Integer _updateVariable(INonLinearSystem * system)
  {
    IIterationNonLinearModel* ptr = dynamic_cast<IIterationNonLinearModel*>(m_variable_updater) ;
    if(ptr)
      ptr->setCurrentNonLinearIteration(m_iteration) ;
    return system->accept(m_variable_updater);
  }

  //! Print global info
  void _print() const;

  //! Print iteration info
  void _printIteration() const;

  //! Print residual info in file (Gnuplot format)
  void _printResidual() const;

  enum eSolverStatus { Converged, NotConverged, PhysicalError, InitialGuessError, LinearSolverError };

 private:

  bool m_initialized = false ;

  //! Non linear builder
  INonLinearSystemBuilder *                   m_non_linear_system_builder  = nullptr;

  //! Linear builder
  ILinearSystemBuilder *                      m_linear_system_builder      = nullptr;

  //! Linear solver
  LocalDirectSolverNamespace::ILinearSolver * m_linear_solver              = nullptr;
  Alien::ILinearSolver *                      m_linear_solver2             = nullptr;

  //! Variable updater
  INonLinearSystemVisitor *                   m_variable_updater           = nullptr;

  //! Nb max of iteration
  Integer m_max_iteration = 0;

  //! stop criteria value
  Real m_stop_criteria_value = 0.;

  //! Current iteration
  Integer m_iteration = 0;

  bool m_force_one_linear_step = false;

  //! Stop criteria
  bool m_default_stop_criteria = false;
  INonLinearStopCriteria * m_stop_criteria = nullptr;

  //! Info
  Integer m_total_non_linear_solver_iteration = 0;
  Integer m_total_linear_solver_iteration     = 0;
  Integer m_total_succeed_resolution          = 0;
  Integer m_total_resolution                  = 0;

  //! Instrumentalization
  Timer m_solver_timer;
  Timer m_solver_cpu_timer;
  Timer m_build_timer;
  Timer m_build_cpu_timer;

  //! Local arrays
  SharedArray<Real> m_residual;
  SharedArray<Real> m_linear_solver_residual;
  SharedArray<Real> m_linear_solver_iteration;

  //! Convergence status
  eSolverStatus m_status;

  Status m_solver_status ;

  //! Output flag
  Integer m_output_level = 0;

  //! Output residual flag
  bool m_output_residual = false;

  //! File name to be completed with iteration
  String m_root_file_name;
};

#endif /* ARCGEOSIM_NUMERICS_NONLINEARSOLVER_NEWTONIMPL_NEWTONSOLVERSERVICE_H */
