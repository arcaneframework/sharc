// -*- C++ -*-
#pragma once
/* Author : desrozis at Tue Nov 13 08:40:09 2012
 * Generated by createNew
 */

#include "ArcGeoSim/Numerics/Contribution/Contribution.h"
#include "ArcGeoSim/Numerics/Contribution/Stencil.h"

//---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

namespace ArcNum {
BEGIN_AUDI_NAMESPACE

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

class BaseVariable
{
public:

  BaseVariable():
    m_stencil_size(0)
    {}

  BaseVariable(const BaseVariable& rhs):
    m_stencil_size(rhs.m_stencil_size),
    m_ad_value(rhs.m_ad_value)
    {}

  template<typename MappingT>
  BaseVariable(ConstArrayView<MappingT> offsets):
    m_stencil_size(offsets.size()-1),
    m_ad_value(m_stencil_size)
  {
    Arcane::Integer stencil_unknown_offset = 0;
    for(Arcane::Integer i = 0; i < m_stencil_size; ++i) {
      const MappingT map_prop = offsets[i+1];
      if(map_prop.propertyOffset()!=-1) {
        Arcane::Integer idx_der = stencil_unknown_offset + map_prop.propertyOffset();
        RootContribution identity(0.,idx_der,1.);
        m_ad_value[i] = std::make_pair(identity,false);
      }
      else {
        Arcane::ConstArrayView<Arcane::Integer> law_dependencies_offset = map_prop.referenceOffset();
        //compute max offset
        Arcane::Integer max_offset = -1;
        for(Arcane::Integer j = 0; j < law_dependencies_offset.size() ; ++j)
          max_offset = (law_dependencies_offset[j]>max_offset) ? law_dependencies_offset[j] : max_offset;
        // idx derivatives
        std::vector<int> idx_deriv(max_offset+1,-1);
        Arcane::ConstArrayView<Arcane::Integer> unknown_offset = map_prop.userOffset();
        for(Arcane::Integer j = 0; j < map_prop.properties().size() ; ++j)
          idx_deriv[law_dependencies_offset[j]] = stencil_unknown_offset + unknown_offset[j];
        //
        RootContribution contrib(0.,idx_deriv);
        const bool status = contrib.size()>0 ;
        m_ad_value[i] = std::make_pair(contrib,status);
      }
      stencil_unknown_offset+=map_prop.userDependencies().dataSize();
    }
  }

  virtual ~BaseVariable() {}

public:

  Arcane::Integer stencilSize() const { return m_stencil_size; }

private:

  Arcane::Integer m_stencil_size;

protected:

  mutable Arcane::SharedArray<std::pair<ArcNum::RootContribution,bool>> m_ad_value;

};

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

END_AUDI_NAMESPACE
}
/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

