/* Author : havep at Mon Jun 30 18:00:20 2008
 * Generated by createNew
 */

/* Doc en ligne 
 * http://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/KSP/KSPSetOptionsPrefix.html#KSPSetOptionsPrefix
 * https://bitbucket.org/petsc/petsc-3.3/src/fb831f418c2c/src/ksp/ksp/examples/tutorials/ex42.c?at=default
 * https://bitbucket.org/petsc/petsc-3.3/src/fb831f418c2c/src/ksp/ksp/examples/tutorials?at=default
 */

#include "ArcGeoSim/Numerics/LinearSolver/PETScSolverImpl/IPETScKSP.h"
#include "ArcGeoSim/Numerics/LinearSolver/PETScSolverImpl/IPETScPC.h"
#include "ArcGeoSim/Numerics/LinearSolver/PETScSolverImpl/PETScInitType.h"
#include <arcane/IParallelMng.h>

using namespace Arcane;
using namespace ArcGeoSim::Numerics;
#include "PETScSolverConfigCustom_axl.h"
#include "ArcGeoSim/Numerics/LinearSolver/PETScSolverImpl/PETScInternal.h"

#include "petscversion.h"

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

// BEGIN_LINEARALGEBRA2SERVICE_NAMESPACE

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

class PETScSolverConfigCustomService :
  public ArcanePETScSolverConfigCustomObject
{
public:
  /** Constructeur de la classe */
  PETScSolverConfigCustomService(const Arcane::ServiceBuildInfo & sbi)
  : ArcanePETScSolverConfigCustomObject(sbi)
    {
      ;
    }
  
  /** Destructeur de la classe */
  virtual ~PETScSolverConfigCustomService() {}
  
public:

  //! Initialisation du système
  void configure(PETScInternal * internal);

  //! Initialisation du solveur
  void configure(KSP & ksp, const Alien::IIndexManager * indexManager);

  //! Indicateur de support de résolution parallèle
  bool hasParallelSupport() const { return true; }

public:
  //! Acces to TraceMng
  ITraceMng * traceMng() const { return BasicService::traceMng();  }
private :
};

/*---------------------------------------------------------------------------*/

void 
PETScSolverConfigCustomService::
configure(PETScInternal * internal)
{
  if (subDomain()->parallelMng()->commSize() > 1) {
    internal->m_matrix_type = MATMPIAIJ;
    internal->m_parallel = true;
  } else {
    internal->m_matrix_type = MATSEQAIJ;
    internal->m_parallel = false;
  }
}

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

void
PETScSolverConfigCustomService::
configure(KSP & ksp, const Alien::IIndexManager * indexManager)
{
  /* Idée pour Schur en ligne de commande.:
   * charger les options avec PetscOptionsSetValue
   * https://bitbucket.org/petsc/petsc-3.3/src/fb831f418c2c/src/ksp/ksp/examples/tutorials?at=default : ex42 et ses options
   * dont https://bitbucket.org/petsc/petsc-3.3/src/fb831f418c2c/src/ksp/ksp/examples/tutorials/ex42-mgschur.opts?at=default
   * https://bitbucket.org/petsc/petsc-3.3/src/fb831f418c2c/src/ksp/ksp/examples/tutorials/ex42.c?at=default
   */

  String prefix = String::format("{0}_",this);

  ConstArrayView<CaseOptionsPETScSolverConfigCustom::CaseOptionCommandLineOptionValue*> petsc_options = options()->option();
  for(Integer i=0;i<petsc_options.size();++i)
    {
      String name = petsc_options[i]->name();
      String value = petsc_options[i]->value();
#if ((PETSC_VERSION_MAJOR <= 3 && PETSC_VERSION_MINOR < 7) || (PETSC_VERSION_MAJOR < 3))
      checkError("Set CommandLine Option ", PetscOptionsSetValue(String::format("-{0}{1}",prefix,name).localstr(),value.localstr()));
#else
      checkError("Set CommandLine Option ", PetscOptionsSetValue(NULL, String::format("-{0}{1}",prefix,name).localstr(),value.localstr()));
#endif
    }

  checkError("Set CommandLine Option Prefix",KSPSetOptionsPrefix(ksp,prefix.localstr()));
  checkError("Configure solver from options",KSPSetFromOptions(ksp));
}

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

ARCANE_REGISTER_SERVICE_PETSCSOLVERCONFIGCUSTOM(Custom,PETScSolverConfigCustomService);

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

// END_LINEARALGEBRA2SERVICE_NAMESPACE

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/
