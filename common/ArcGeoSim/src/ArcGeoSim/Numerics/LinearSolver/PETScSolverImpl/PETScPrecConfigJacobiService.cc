/* Author : havep at Mon Jun 30 17:55:25 2008
 * Generated by createNew
 */

#include "ArcGeoSim/Numerics/LinearAlgebra2/PETScImpl/PETScPrecomp.h"
#include "ArcGeoSim/Numerics/LinearSolver/PETScSolverImpl/IPETScPC.h"
#include "ArcGeoSim/Numerics/LinearSolver/PETScSolverImpl/IPETScKSP.h"

using namespace Arcane;
using namespace ArcGeoSim::Numerics;
#include "PETScPrecConfigJacobi_axl.h"

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

// BEGIN_LINEARALGEBRA2SERVICE_NAMESPACE

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

class PETScPrecConfigJacobiService :
  public ArcanePETScPrecConfigJacobiObject
{
public:
  /** Constructeur de la classe */
  PETScPrecConfigJacobiService(const Arcane::ServiceBuildInfo & sbi) : 
    ArcanePETScPrecConfigJacobiObject(sbi) 
    {
      ;
    }
  
  /** Destructeur de la classe */
  virtual ~PETScPrecConfigJacobiService() {}

public:
  //! Initialisation
  void configure(PC & pc, const Alien::IIndexManager * indexManager);

  //! Indicateur de support de résolution parallèle
  bool hasParallelSupport() const { return true; }

  //! Check need of KSPSetUp before calling this PC configure
  bool needPrematureKSPSetUp() const;

public:
  //! Acces to TraceMng
  ITraceMng * traceMng() const { return BasicService::traceMng();  }
};

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

void 
PETScPrecConfigJacobiService::
configure(PC & pc, const Alien::IIndexManager * indexManager)
{
  checkError("Set preconditioner",PCSetType(pc,PCBJACOBI));
  // KSPSetUp has been already called (cf needPrematureKSPSetUp)
  // you can set up sub solver using PCBJacobiGetSubKSP (for PCBJACOBI ie by block)
  // details in http://www-unix.mcs.anl.gov/petsc/petsc-as/snapshots/petsc-current/src/ksp/ksp/examples/tutorials/ex7.c.html

  checkError("Preconditioner setup",PCSetUp(pc));
  
  // Extract the array of KSP contexts for the local blocks
  PetscInt nlocal, first;
  KSP *subksp;
  checkError("Preconditioner gets sub-solvers",PCBJacobiGetSubKSP(pc, &nlocal, &first, &subksp));
  // info() << "level = " << options()->level() << "shift = " <<  options()->shift();

  for(Integer i=first;i<nlocal;i++){
    PC subpc;
    // checkError("Preconditioner sub-solver config",KSPSetType(subksp[i],KSPPREONLY));
    checkError("Preconditioner sub-preconditioner",KSPGetPC(subksp[i],&subpc));
    checkError("Preconditioner sub-preconditioner setup",PCSetType(subpc,PCILU));
    checkError("Preconditioner sub-preconditioner config",PCFactorSetLevels(subpc,options()->level()));
    checkError("Preconditioner sub-preconditioner config",PCFactorSetShiftAmount(subpc,options()->shift()));
  }
}

/*---------------------------------------------------------------------------*/

bool
PETScPrecConfigJacobiService::
needPrematureKSPSetUp() const
{
  return true;
}

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

ARCANE_REGISTER_SERVICE_PETSCPRECCONFIGJACOBI(Jacobi,PETScPrecConfigJacobiService);
ARCANE_REGISTER_SERVICE_PETSCPRECCONFIGJACOBI(ILU,PETScPrecConfigJacobiService);
ARCANE_REGISTER_SERVICE_PETSCPRECCONFIGJACOBI(BlockILU,PETScPrecConfigJacobiService);

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

// END_LINEARALGEBRA2SERVICE_NAMESPACE

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/


