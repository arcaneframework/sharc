/* Author : havep at Tue Jul 29 18:45:26 2008
 * Generated by createNew
 */

#include "ArcGeoSim/Numerics/LinearAlgebra2/PETScImpl/PETScPrecomp.h"
#include "ArcGeoSim/Numerics/LinearSolver/PETScSolverImpl/IPETScPC.h"

#include <arcane/ArcaneException.h>

struct PETScPrecConfigHypreOptions {
  enum eType 
    {
      PILUT,
      AMG,
      ParaSails,
      Euclid
    };
};

using namespace Arcane;
using namespace ArcGeoSim::Numerics;
#include "PETScPrecConfigHypre_axl.h"

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

class PETScPrecConfigHypreService :
  public ArcanePETScPrecConfigHypreObject
{
public:
  /** Constructeur de la classe */
  PETScPrecConfigHypreService(const Arcane::ServiceBuildInfo & sbi) : 
    ArcanePETScPrecConfigHypreObject(sbi) 
    {
      ;
    }
  
  /** Destructeur de la classe */
  virtual ~PETScPrecConfigHypreService() {}

public:

  //! Initialisation
  void configure(PC & pc, const Alien::IIndexManager * indexManager);

  //! Indicateur de support de résolution parallèle
  bool hasParallelSupport() const { return true; }

  //! Check need of KSPSetUp before calling this PC configure
  virtual bool needPrematureKSPSetUp() const;

public:
  //! Acces to TraceMng
  ITraceMng * traceMng() const { return BasicService::traceMng();  }
};

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

void 
PETScPrecConfigHypreService::
configure(PC & pc, const Alien::IIndexManager * indexManager)
{
  if(!options()->fieldSplitMode())
    checkError("Set preconditioner",PCSetType(pc,PCHYPRE));
  // for more options see
  // http://www-unix.mcs.anl.gov/petsc/petsc-as/snapshots/petsc-current/docs/manualpages/PC/PCHYPRE.html

  switch (options()->type()) {
  case PETScPrecConfigHypreOptions::PILUT:
    checkError("Set Hypre preconditioner",PCHYPRESetType(pc,"pilut"));
    break;
  case PETScPrecConfigHypreOptions::AMG:
    checkError("Set Hypre preconditioner",PCHYPRESetType(pc,"boomeramg"));
    break;
  case PETScPrecConfigHypreOptions::ParaSails:
    checkError("Set Hypre preconditioner",PCHYPRESetType(pc,"parasails"));
    break;
  case PETScPrecConfigHypreOptions::Euclid:
    checkError("Set Hypre preconditioner",PCHYPRESetType(pc,"euclid"));
    break;
  default:
    throw InternalErrorException(A_FUNCINFO,"Undefined Hypre type");
  }
}

/*---------------------------------------------------------------------------*/

bool
PETScPrecConfigHypreService::
needPrematureKSPSetUp() const
{
  return false;
}

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

ARCANE_REGISTER_SERVICE_PETSCPRECCONFIGHYPRE(Hypre,PETScPrecConfigHypreService);

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

