/* Author : havep at Mon Jun 30 17:55:25 2008
 * Generated by createNew
 */

#include "ArcGeoSim/Numerics/LinearAlgebra2/PETScImpl/PETScPrecomp.h"
#include "ArcGeoSim/Numerics/LinearSolver/PETScSolverImpl/IPETScKSP.h"
#include "ArcGeoSim/Numerics/LinearSolver/PETScSolverImpl/IPETScPC.h"
#include "ArcGeoSim/Numerics/LinearAlgebra2/IIndexManager.h"
#include <arcane/IParallelMng.h>

#include "petscversion.h"

/*---------------------------------------------------------------------------*/
#if ((PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 3) || (PETSC_VERSION_MAJOR > 3))
/*---------------------------------------------------------------------------*/

using namespace Arcane;
using namespace ArcGeoSim::Numerics;
#include "PETScPrecConfigLU_axl.h"

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

// BEGIN_LINEARALGEBRA2SERVICE_NAMESPACE

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

class PETScPrecConfigLUService :
  public ArcanePETScPrecConfigLUObject
{
public:
  /** Constructeur de la classe */
  PETScPrecConfigLUService(const Arcane::ServiceBuildInfo & sbi) : 
    ArcanePETScPrecConfigLUObject(sbi) 
    {
      ;
    }
  
  /** Destructeur de la classe */
  virtual ~PETScPrecConfigLUService() {}

public:
  //! Initialisation
  void configure(PC & pc, const Alien::IIndexManager * indexManager);

  //! Indicateur de support de résolution parallèle
  bool hasParallelSupport() const { return false; }

  //! Check need of KSPSetUp before calling this PC configure
  bool needPrematureKSPSetUp() const;

public:
  //! Acces to TraceMng
  ITraceMng * traceMng() const { return BasicService::traceMng();  }
};

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

void 
PETScPrecConfigLUService::
configure(PC & pc, const Alien::IIndexManager * indexManager)
{
  Arcane::IParallelMng * parallel_mng  = subDomain()->parallelMng();
  if (indexManager == NULL)
    warning() << "LU sub indexManager not defined";
  // Arcane::IParallelMng * parallel_mng  = indexManager->parallelMng(); // dès que les sous-index-manager seront gérés

  checkError("Set preconditioner",PCSetType(pc,PCLU));
  if (parallel_mng->commSize() > 1)
    fatal() << "LU solver of PETSc is sequential"; 
  checkError("Set petsc lu solver package",PCFactorSetMatSolverPackage(pc,MATSOLVERPETSC));

  // checkError("Set fill factor",  PCFactorSetUpMatSolverPackage(pc));

  if (options()->fillFactor() < 1.0)
    fatal() << "Bad Fill Factor: cannot be less than 1.0";

  checkError("Set fill factor",PCFactorSetFill(pc, options()->fillFactor()));
  // checkError("Set shift type",PCFactorSetShiftType(pc,PETSC_DECIDE));
  checkError("Set shift amount",PCFactorSetShiftAmount(pc, PETSC_DECIDE));

  checkError("Preconditioner setup",PCSetUp(pc));
}

/*---------------------------------------------------------------------------*/

bool
PETScPrecConfigLUService::
needPrematureKSPSetUp() const
{
  return true;
}

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

ARCANE_REGISTER_SERVICE_PETSCPRECCONFIGLU(LU,PETScPrecConfigLUService);

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

// END_LINEARALGEBRA2SERVICE_NAMESPACE

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

/*---------------------------------------------------------------------------*/
#endif /* PETSC_VERSION */
/*---------------------------------------------------------------------------*/
