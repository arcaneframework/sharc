/* Author : havep at Mon Jun 30 18:00:20 2008
 * Generated by createNew
 */

#include "ArcGeoSim/Numerics/LinearAlgebra2/PETScImpl/PETScPrecomp.h"
#include "ArcGeoSim/Numerics/LinearSolver/PETScSolverImpl/IPETScKSP.h"
#include "ArcGeoSim/Numerics/LinearSolver/PETScSolverImpl/IPETScPC.h"
#include "ArcGeoSim/Numerics/LinearSolver/PETScSolverImpl/PETScInitType.h"
#include <arcane/IParallelMng.h>

using namespace Arcane;
using namespace ArcGeoSim::Numerics;
#include "PETScSolverConfigBiCGStab_axl.h"
#include "ArcGeoSim/Numerics/LinearSolver/PETScSolverImpl/PETScInternal.h"

#include "petscversion.h"

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

// BEGIN_LINEARALGEBRA2SERVICE_NAMESPACE

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

class PETScSolverConfigBiCGStabService :
  public ArcanePETScSolverConfigBiCGStabObject
{
public:
  /** Constructeur de la classe */
  PETScSolverConfigBiCGStabService(const Arcane::ServiceBuildInfo & sbi)
  : ArcanePETScSolverConfigBiCGStabObject(sbi)
    {
      ;
    }
  
  /** Destructeur de la classe */
  virtual ~PETScSolverConfigBiCGStabService() {}
  
public:

  //! Initialisation du système
  void configure(PETScInternal * internal);

  //! Initialisation du solveur
  void configure(KSP & ksp, const Alien::IIndexManager * indexManager);

  //! Indicateur de support de résolution parallèle
  bool hasParallelSupport() const;

public:
  //! Acces to TraceMng
  ITraceMng * traceMng() const { return BasicService::traceMng();  }
private :
};

/*---------------------------------------------------------------------------*/

void 
PETScSolverConfigBiCGStabService::
configure(PETScInternal * internal)
{
  if (subDomain()->parallelMng()->commSize() > 1) {
    internal->m_matrix_type = MATMPIAIJ;
    internal->m_parallel = true;
  } else {
    internal->m_matrix_type = MATSEQAIJ;
    internal->m_parallel = false;
  }
}

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

void
PETScSolverConfigBiCGStabService::
configure(KSP & ksp, const Alien::IIndexManager * indexManager)
{
  PETScInitType::apply(this,ksp,options()->initType());

  checkError("Set solver tolerances",KSPSetTolerances(ksp,
                                                      options()->stopCriteriaValue(),
                                                      1e-15,
                                                      PETSC_DEFAULT,
                                                      options()->numIterationsMax()));
  checkError("Solver set type",KSPSetType(ksp,KSPBCGS));

  if (options()->right())
    {
#if ((PETSC_VERSION_MAJOR <= 3 && PETSC_VERSION_MINOR < 3) || (PETSC_VERSION_MAJOR < 3))
      checkError(" Set solver preconditioner side ", KSPSetPreconditionerSide(ksp,PC_RIGHT));
#else /* PETSC_VERSION */
      checkError(" Set solver preconditioner side ", KSPSetPCSide(ksp,PC_RIGHT));
#endif /* PETSC_VERSION */
      checkError(" Set solver unpreconditioned norm type ", KSPSetNormType(ksp, KSP_NORM_UNPRECONDITIONED));
    }

  PC pc;
  checkError("Get preconditioner",KSPGetPC(ksp,&pc));
  IPETScPC * preconditioner = options()->preconditioner();
  bool needSetUp = preconditioner->needPrematureKSPSetUp();
  if (needSetUp)
    {
      checkError("Solver setup",KSPSetUp(ksp));
      preconditioner->configure(pc,indexManager);
    }
  else
    {
      preconditioner->configure(pc,indexManager);
      checkError("Solver setup",KSPSetUp(ksp));
    }
}


/*---------------------------------------------------------------------------*/

bool
PETScSolverConfigBiCGStabService::
hasParallelSupport() const
{
  return options()->preconditioner()->hasParallelSupport();
}

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

ARCANE_REGISTER_SERVICE_PETSCSOLVERCONFIGBICGSTAB(BiCGStab,PETScSolverConfigBiCGStabService);

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

// END_LINEARALGEBRA2SERVICE_NAMESPACE

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/
