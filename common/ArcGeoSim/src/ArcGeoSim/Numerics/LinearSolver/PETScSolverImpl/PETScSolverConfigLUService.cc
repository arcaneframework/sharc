/* Author : havep at Mon Jun 30 16:04:32 2008
 * Generated by createNew
 */

#include "ArcGeoSim/Numerics/LinearAlgebra2/PETScImpl/PETScPrecomp.h"
#include "ArcGeoSim/Numerics/LinearSolver/PETScSolverImpl/IPETScKSP.h"
#include "ArcGeoSim/Numerics/LinearSolver/PETScSolverImpl/IPETScPC.h"
#include "ArcGeoSim/Numerics/LinearAlgebra2/IIndexManager.h"

#include <arcane/IParallelMng.h>

using namespace Arcane;
using namespace ArcGeoSim::Numerics;
#include "PETScSolverConfigLU_axl.h"
#include "ArcGeoSim/Numerics/LinearSolver/PETScSolverImpl/PETScInternal.h"

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

// BEGIN_LINEARALGEBRA2SERVICE_NAMESPACE

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

class PETScSolverConfigLUService :
  public ArcanePETScSolverConfigLUObject
{
public:
  /** Constructeur de la classe */
  PETScSolverConfigLUService(const Arcane::ServiceBuildInfo & sbi) : 
    ArcanePETScSolverConfigLUObject(sbi) 
    {
      ;
    }
  
  /** Destructeur de la classe */
  virtual ~PETScSolverConfigLUService() {}
  
public:

  //! Initialisation du système
  void configure(PETScInternal * internal);

  //! Indicateur de support de résolution parallèle
  bool hasParallelSupport() const { return false; }

  //! Initialisation du solveur
  void configure(KSP & ksp, const Alien::IIndexManager * indexManager);

public:
  //! Acces to TraceMng
  ITraceMng * traceMng() const { return BasicService::traceMng();  }
};

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

void 
PETScSolverConfigLUService::
configure(PETScInternal * internal)
{
  if (subDomain()->parallelMng()->commSize() > 1) {
    internal->m_matrix_type = MATMPIAIJ;
    internal->m_parallel = true;
  } else {
    internal->m_matrix_type = MATSEQAIJ;
    internal->m_parallel = false;
  }
}

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

void 
PETScSolverConfigLUService::
configure(KSP & ksp, const Alien::IIndexManager * indexManager)
{
  Arcane::IParallelMng * parallel_mng  = subDomain()->parallelMng();
  if (indexManager == NULL)
    warning() << "LU sub indexManager not defined";
  // Arcane::IParallelMng * parallel_mng  = indexManager->parallelMng(); // dès que les sous-index-manager seront gérés

  checkError("Set solver tolerances",KSPSetTolerances(ksp,
                                                      1e-9,
                                                      1e-15,
                                                      PETSC_DEFAULT,
                                                      2)); 

   checkError("Solver set type",KSPSetType(ksp,KSPPREONLY));
   PC pc;
   checkError("Get preconditioner",KSPGetPC(ksp,&pc));
   checkError("Preconditioner set type",PCSetType(pc,PCLU));
                                                     
#if ((PETSC_VERSION_MAJOR <= 3 && PETSC_VERSION_MINOR < 3) || (PETSC_VERSION_MAJOR < 3))
   if (parallel_mng->commSize() > 1)
     fatal() << "LU solver of PETSc is sequential"; 
   checkError("Set petsc lu solver package",PCFactorSetMatSolverPackage(pc,MAT_SOLVER_PETSC));
#else /* PETSC_VERSION */
   if (parallel_mng->commSize() > 1)
     fatal() << "LU solver of PETSc is sequential"; 
   checkError("Set petsc lu solver package",PCFactorSetMatSolverPackage(pc,MATSOLVERPETSC));
#endif /* PETSC_VERSION */

  KSPSetUp(ksp);
}

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

ARCANE_REGISTER_SERVICE_PETSCSOLVERCONFIGLU(LU,PETScSolverConfigLUService);

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

// END_LINEARALGEBRA2SERVICE_NAMESPACE

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/
