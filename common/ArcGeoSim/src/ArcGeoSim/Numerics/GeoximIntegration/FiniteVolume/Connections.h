// -*- C++ -*-
#ifndef ARCGEOSIM_NUMERICS_FINITEVOLUME_CONNECTIONS_H_
#define ARCGEOSIM_NUMERICS_FINITEVOLUME_CONNECTIONS_H_

/* Author : dechaiss at Dec 12, 2014 2:49:08 PM 2014
 * Generated by createNew
 */

// !!!!! VIENS DE GEOXIM/MESH (A RAPPROCHER DE L IMPORTEUR IXM)

#include <arcane/utils/ITraceMng.h>

#include "ArcGeoSim/Mesh/Utils/IXMTools/IXMItemConnections.h"

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

namespace ArcNum {

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

namespace Connection
{

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

#if (ARCANE_VERSION >= 30003)
  inline ArcGeoSim::ItemConnectionGroup notMatchingConnectionFacet(Arcane::IMesh* mesh, Arcane::IGraph2* graph)
  {
    ArcGeoSim::ItemConnectionMng item_connections(mesh,graph);
    ArcGeoSim::ItemConnectionGroup face_face_connections = item_connections.findConnectionGroup("FaceFaceConnections"); // Name exported by open flow
    return face_face_connections;
  }
#else
inline ArcGeoSim::ItemConnectionGroup notMatchingConnectionFacet(Arcane::IMesh* mesh)
{
  ArcGeoSim::ItemConnectionMng item_connections(mesh);
  ArcGeoSim::ItemConnectionGroup face_face_connections = item_connections.findConnectionGroup("FaceFaceConnections"); // Name exported by open flow
  return face_face_connections;
}
#endif
/*---------------------------------------------------------------------------*/

inline ArcGeoSim::VariableItemConnectionReal notMatchingConnectionFacetMeasure(Arcane::IMesh* mesh)
{
  return Arcane::VariableBuildInfo(mesh,"Geom_Intersection_Measure");
}

/*---------------------------------------------------------------------------*/

#if (ARCANE_VERSION >= 30003)
inline void printNotMatchingConnectionFacets(Arcane::IMesh* mesh,Arcane::IGraph2* graph, Arcane::ITraceMng* trace_mng)
#else
inline void printNotMatchingConnectionFacets(Arcane::IMesh* mesh, Arcane::ITraceMng* trace_mng)
#endif
{
  // DEBUG for Connection //
  Arcane::VariableCellInt64* cell_uid = new Arcane::VariableCellInt64(Arcane::VariableBuildInfo(mesh,"CellUid"));
  ENUMERATE_CELL(icell,mesh->allCells())
  {
    (*cell_uid)[icell] = icell->uniqueId().asInt64();
  }

#if (ARCANE_VERSION >= 30003)
  ArcGeoSim::ItemConnectionMng item_connection_mng(mesh,graph);
#else
  ArcGeoSim::ItemConnectionMng item_connection_mng(mesh);
#endif

  trace_mng->info() << " Mesh has connections ? " << item_connection_mng.hasConnection();

  // Group FaceFaceConnections is included in My_Connections (see ixm mesh file file)
#if (ARCANE_VERSION >= 30003)
  ENUMERATE_FACEFACE_CONNECTION(ifaceface,Connection::notMatchingConnectionFacet(mesh,graph))
  {
    trace_mng->info() << "++++++++++++++++++++++++++++++++++++++++++++";
    trace_mng->info() << "Connection id " << ifaceface->uniqueId();
    trace_mng->info() << "Connection first face back  cell uid : " << ifaceface->first(graph).backCell().uniqueId().asInt64();
    trace_mng->info() << "Connection first face front cell uid : " << ifaceface->first(graph).frontCell().uniqueId().asInt64();
    trace_mng->info() << "Connection second face back  cell uid : " << ifaceface->second(graph).backCell().uniqueId().asInt64();
    trace_mng->info() << "Connection second face front cell uid : " << ifaceface->second(graph).frontCell().uniqueId().asInt64();

    bool isOKFace1 = ( ifaceface->first(graph).frontCell().uniqueId().asInt64() == -1 )  | ( ifaceface->first(graph).backCell().uniqueId().asInt64() == -1 );
    bool isOKFace2 = ( ifaceface->second(graph).frontCell().uniqueId().asInt64() == -1 ) | ( ifaceface->second(graph).backCell().uniqueId().asInt64() == -1 );

    if ( isOKFace1 == false )
      trace_mng->info() << "Error Face 1 is Internal";

    if ( isOKFace2 == false )
      trace_mng->info() << "Error Face 2 is Internal";

    trace_mng->info() << "++++++++++++++++++++++++++++++++++++++++++++";
  }
#else
  ENUMERATE_FACEFACE_CONNECTION(ifaceface,Connection::notMatchingConnectionFacet(mesh))
  {
    trace_mng->info() << "++++++++++++++++++++++++++++++++++++++++++++";
    trace_mng->info() << "Connection id " << ifaceface->uniqueId();
    trace_mng->info() << "Connection first face back  cell uid : " << ifaceface->first().backCell().uniqueId().asInt64();
    trace_mng->info() << "Connection first face front cell uid : " << ifaceface->first().frontCell().uniqueId().asInt64();
    trace_mng->info() << "Connection second face back  cell uid : " << ifaceface->second().backCell().uniqueId().asInt64();
    trace_mng->info() << "Connection second face front cell uid : " << ifaceface->second().frontCell().uniqueId().asInt64();

    bool isOKFace1 = ( ifaceface->first().frontCell().uniqueId().asInt64() == -1 )  | ( ifaceface->first().backCell().uniqueId().asInt64() == -1 );
    bool isOKFace2 = ( ifaceface->second().frontCell().uniqueId().asInt64() == -1 ) | ( ifaceface->second().backCell().uniqueId().asInt64() == -1 );

    if ( isOKFace1 == false )
      trace_mng->info() << "Error Face 1 is Internal";

    if ( isOKFace2 == false )
      trace_mng->info() << "Error Face 2 is Internal";

    trace_mng->info() << "++++++++++++++++++++++++++++++++++++++++++++";
  }
#endif

}

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

}

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

}

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

#endif /* ARCGEOSIM_CONNECTIONS_H_ */
