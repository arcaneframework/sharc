// -*- tab-width: 2; indent-tabs-mode: nil; coding: utf-8-with-signature -*-
//-----------------------------------------------------------------------------
// Copyright 2000-2025 CEA (www.cea.fr) IFPEN (www.ifpenergiesnouvelles.com)
// See the top-level COPYRIGHT file for details.
// SPDX-License-Identifier: Apache-2.0
//-----------------------------------------------------------------------------
#include "SimpleAbstractFamily.h"
/* Author : havep at Mon Jan 14 18:30:40 2013
 * Generated by createNew
 */

#include <algorithm>

using namespace Arcane;

/*---------------------------------------------------------------------------*/

BEGIN_ALIEN_NAMESPACE

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/

SimpleAbstractFamily::
SimpleAbstractFamily(const Int64ConstArrayView uniqueIds,
                     const IntegerConstArrayView owners,
                     IIndexManager * manager)
  : m_manager(manager)
  , m_unique_ids(uniqueIds)
  , m_owners(owners)
{
  ;
}

/*---------------------------------------------------------------------------*/

SimpleAbstractFamily::
SimpleAbstractFamily(const Int64ConstArrayView uniqueIds,
                     IIndexManager * manager)
  : m_manager(manager)
{
  Arcane::IParallelMng * parallelMng = m_manager->parallelMng();
  const Integer commSize = parallelMng->commSize();
  const Integer commRank = parallelMng->commRank();
  const Integer localSize = uniqueIds.size();
  Arcane::IntegerSharedArray sizes(commSize);
  parallelMng->allGather(IntegerConstArrayView(1,&localSize),sizes);
  Arcane::IntegerSharedArray starts(commSize+1);
  starts[0] = 0;
  for(Integer i=0;i<commSize;++i)
    starts[i+1] = starts[i] + sizes[i];

  Arcane::Int64SharedArray allUniqueIds;
  parallelMng->allGatherVariable(uniqueIds, allUniqueIds);
  m_unique_ids.reserve(allUniqueIds.size());
  m_owners.reserve(allUniqueIds.size());
  
  // remise en t�te des uids locaux associ� � commRank
  m_unique_ids.addRange(allUniqueIds.subView(starts[commRank],sizes[commRank]));
  m_owners.addRange(commRank, sizes[commRank]);
  for(Integer iRank=0;iRank<commSize;++iRank)
    {
      if (iRank != commRank)
        {
          m_unique_ids.addRange(allUniqueIds.subView(starts[iRank],sizes[iRank]));
          m_owners.addRange(iRank, sizes[iRank]);
        }
    }

#ifndef NDEBUG
  ARCANE_ASSERT((m_unique_ids.size() == allUniqueIds.size()),("Inconsistant sizes"));
  ARCANE_ASSERT((m_owners.size() == allUniqueIds.size()),("Inconsistant sizes"));
  for(Integer i=0;i<localSize;++i)
    {
      ARCANE_ASSERT((m_unique_ids[i] == uniqueIds[i]),("Bad local numbering"));
      ARCANE_ASSERT((m_owners[i] == commRank),("Bad local owner"));
    }

  // Check duplicated uids
  std::sort(allUniqueIds.begin(), allUniqueIds.end());
  for(Integer i=1;i<allUniqueIds.size();++i)
    ARCANE_ASSERT((allUniqueIds[i-1] != allUniqueIds[i]),("Duplicated uid"));
#endif /* NDEBUG */
}

/*---------------------------------------------------------------------------*/

SimpleAbstractFamily::
~SimpleAbstractFamily() 
{ 
  m_manager->keepAlive(this);
}
  
/*---------------------------------------------------------------------------*/

void 
SimpleAbstractFamily::
uniqueIdToLocalId(Int32ArrayView localIds, Int64ConstArrayView uniqueIds) const 
{ 
  for(Integer i=0;i<uniqueIds.size();++i)
    {
      Integer localId = -1;
      for(Integer j=0;j<m_unique_ids.size();++j)
        if (uniqueIds[i] == m_unique_ids[j])
          { localId = j; break; }
      if (localId == -1)
        throw Arcane::FatalErrorException(A_FUNCINFO,"UniqueId not found");
      localIds[i] = localId;
    }
}

/*---------------------------------------------------------------------------*/

IIndexManager::IAbstractFamily::Item 
SimpleAbstractFamily::
item(Int32 localId) const
{
  return IAbstractFamily::Item(m_unique_ids[localId], 
                               m_owners[localId]);
}

/*---------------------------------------------------------------------------*/

SafeConstArrayView<Integer> 
SimpleAbstractFamily::
owners(Int32ConstArrayView localIds) const
{
  const Integer size = localIds.size();
  SharedArray<Integer> result(size);
  for(Integer i=0;i<size;++i)
    {
      result[i] = m_owners[i];
    }
  return result;
}

/*---------------------------------------------------------------------------*/

SafeConstArrayView<Int64> 
SimpleAbstractFamily::
uids(Int32ConstArrayView localIds) const
{
  const Integer size = localIds.size();
  SharedArray<Int64> result(size);
  for(Integer i=0;i<size;++i)
    {
      result[i] = m_unique_ids[i];
    }
  return result;
}

/*---------------------------------------------------------------------------*/

SafeConstArrayView<Int32>
SimpleAbstractFamily::
allLocalIds() const 
{
  SharedArray<Int32> local_ids(m_unique_ids.size());
  for(Integer i=0;i<m_unique_ids.size();++i)
    local_ids[i] = i;
  return local_ids;
}

/*---------------------------------------------------------------------------*/

END_ALIEN_NAMESPACE

/*---------------------------------------------------------------------------*/
