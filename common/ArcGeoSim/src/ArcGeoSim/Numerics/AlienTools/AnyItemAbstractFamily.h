// -*- tab-width: 2; indent-tabs-mode: nil; coding: utf-8-with-signature -*-
//-----------------------------------------------------------------------------
// Copyright 2000-2025 CEA (www.cea.fr) IFPEN (www.ifpenergiesnouvelles.com)
// See the top-level COPYRIGHT file for details.
// SPDX-License-Identifier: Apache-2.0
//-----------------------------------------------------------------------------
// -*- C++ -*-
#ifndef ARCGEOSIM_ARCGEOSIM_NUMERICS_LINEARALGEBRA2_INDEXMANAGER_ANYITEMABSTRACTFAMILY_H
#define ARCGEOSIM_ARCGEOSIM_NUMERICS_LINEARALGEBRA2_INDEXMANAGER_ANYITEMABSTRACTFAMILY_H
/* Author : havep at Mon Jun  3 12:49:08 2013
 * Generated by createNew
 */


#include "ArcGeoSim/Numerics/AlienTools/IIndexManager.h"

#include <arcane/anyitem/AnyItemFamily.h>
#include <vector>

/*---------------------------------------------------------------------------*/

BEGIN_ALIEN_NAMESPACE

/*---------------------------------------------------------------------------*/

/* Dans cette impl�mentation, implicitement le localId du i_�me item est i */
class AnyItemAbstractFamily 
  : public IIndexManager::IAbstractFamily {
public:
  //! Construit une famille abstraite � partir d'une famille d'AnyItem
  AnyItemAbstractFamily(const Arcane::AnyItem::Family & family,
                        IIndexManager * manager);

  virtual ~AnyItemAbstractFamily();
  
public:
  IIndexManager::IAbstractFamily * clone() const { return new AnyItemAbstractFamily(*this); }

public:
  Integer maxLocalId() const { return m_family.maxLocalId(); }
  void uniqueIdToLocalId(Arcane::Int32ArrayView localIds, Arcane::Int64ConstArrayView uniqueIds) const;
  IAbstractFamily::Item item(Integer localId) const;
  SafeConstArrayView<Integer> owners(Arcane::Int32ConstArrayView localIds) const;
  SafeConstArrayView<Int64> uids(Arcane::Int32ConstArrayView localIds) const;
  SafeConstArrayView<Int32> allLocalIds() const;
  
private:
  const Arcane::AnyItem::Family & m_family;
  IIndexManager * m_manager;
  Arcane::SharedArray<Integer> m_lower_bounds;

private:
  static const Integer m_group_bit_size = 8;
  static const Integer m_group_bit_offset = 55; // 64b - 1b (sign) - 8b (groups)
  static const Int64 m_group_mask = ((Int64(1)<<m_group_bit_size)-1)<<m_group_bit_offset;
  static const Int64 m_item_unique_id_mask = (Int64(1)<<m_group_bit_offset)-1;

  static inline Int64 _form_unique_id(Integer igrp, Int64 item_unique_id) { return ((Int64(igrp)<<m_group_bit_offset) | item_unique_id); }
  static inline Integer _get_igroup(Int64 uid) { return (uid>>m_group_bit_offset); }
  static inline Int64 _get_item_unique_id(Int64 uid) { return (uid&m_item_unique_id_mask); }
};

/*---------------------------------------------------------------------------*/

END_ALIEN_NAMESPACE

/*---------------------------------------------------------------------------*/

#endif /* ARCGEOSIM_ARCGEOSIM_NUMERICS_LINEARALGEBRA2_INDEXMANAGER_ANYITEMABSTRACTFAMILY_H */
