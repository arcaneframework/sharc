// -*- tab-width: 2; indent-tabs-mode: nil; coding: utf-8-with-signature -*-
//-----------------------------------------------------------------------------
// Copyright 2000-2025 CEA (www.cea.fr) IFPEN (www.ifpenergiesnouvelles.com)
// See the top-level COPYRIGHT file for details.
// SPDX-License-Identifier: Apache-2.0
//-----------------------------------------------------------------------------
//-----------------------------------------------------------------------------
// Copyright 2000-2025 CEA (www.cea.fr) IFPEN (www.ifpenergiesnouvelles.com)
// See the top-level COPYRIGHT file for details.
// SPDX-License-Identifier: Apache-2.0
//-----------------------------------------------------------------------------
/* Author : desrozis at Fri Jun 12 14:15:10 2015
 * Generated by createNew
 */
#include "ArcGeoSimMain.h"
#include <arcane/ArcaneVersion.h>
#include <arcane/impl/ArcaneMain.h>
#include <arcane/impl/MainFactory.h>
#include <arcane/IModuleMng.h>
#include <arcane/ISubDomain.h>
#ifdef USE_ARCANE_V3
#include <arcane/launcher/ArcaneLauncher.h>
#include <arcane/utils/CommandLineArguments.h>
#endif

#include "ArcGeoSim/Appli/Architecture/ModuleMaster.h"

//extern "C" ARCANE_EXPORT void
//arcaneRegisterAcceleratorRuntimecuda();

namespace Arcane {
extern "C++" IArcaneMain*
createArcaneMainBatch(const ApplicationInfo& exe_info,IMainFactory*);
}

namespace ArcGeoSim {

  class MainFactory 
    : public Arcane::MainFactory 
  {
  public:
    
    MainFactory(Arcane::String code_name)
      : m_code_name(Arcane::String::format("Master{0}",code_name)) {}
    
    virtual ~MainFactory() {}
    
    Arcane::IModuleMaster* createModuleMaster(Arcane::ISubDomain* sd) {
#ifdef USE_ARCANE_V3
      Arcane::ModuleBuildInfo mbi(sd,sd->defaultMeshHandle(),m_code_name);
#else
      Arcane::ModuleBuildInfo mbi(sd,sd->defaultMesh(),m_code_name);
#endif
      ArcGeoSim::ModuleMaster* master = new ArcGeoSim::ModuleMaster(mbi);
#if (ARCANE_VERSION >= 22200)
      sd->moduleMng()->addModule(makeRef(master));
#else
      sd->moduleMng()->addModule(master);
#endif
      return master;
    }
    
    Arcane::IArcaneMain* createArcaneMain(const Arcane::ApplicationInfo& info) {
      return createArcaneMainBatch(info,this);
    }
    
  private:
    
    const Arcane::String m_code_name;
  };

  
  int main(Arcane::ApplicationInfo& info) {

    int r = 0;
    ArcGeoSim::MainFactory factory(info.applicationName());
#ifndef USE_ARCANE_V3
    Arcane::ArcaneMain::arcaneInitialize();
    r = Arcane::ArcaneMain::arcaneMain(info,&factory);
    Arcane::ArcaneMain::arcaneFinalize();
#else
    Arcane::ArcaneLauncher::init(Arcane::CommandLineArguments(info.commandLineArguments().commandLineArgc(),info.commandLineArguments().commandLineArgv()));
    auto &app_info = Arcane::ArcaneLauncher::applicationInfo();
    app_info = info;
    Arcane::ArcaneLauncher::setDefaultMainFactory(&factory);
    r = Arcane::ArcaneLauncher::run();
#endif




    
    return r; 
  }

}

/*---------------------------------------------------------------------------*/
/*---------------------------------------------------------------------------*/
